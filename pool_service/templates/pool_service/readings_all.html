{% extends "pool_service/base.html" %}

{% block title %}&#1055;&#1083;&#1072;&#1085; &#1074;&#1099;&#1077;&#1079;&#1076;&#1086;&#1074;{% endblock %}

{% block content %}
<div class="calendar-toolbar d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-light btn-sm" href="?month={{ prev_month }}" aria-label="&#1055;&#1088;&#1077;&#1076;&#1099;&#1076;&#1091;&#1097;&#1080;&#1081; &#1084;&#1077;&#1089;&#1103;&#1094;">
      <i class="bi bi-chevron-left"></i>
    </a>
    <div class="calendar-month-label fw-semibold">{{ month_label }}</div>
    <a class="btn btn-light btn-sm" href="?month={{ next_month }}" aria-label="&#1057;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081; &#1084;&#1077;&#1089;&#1103;&#1094;">
      <i class="bi bi-chevron-right"></i>
    </a>
  </div>
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="?month={{ today_month }}">
      &#1057;&#1077;&#1075;&#1086;&#1076;&#1085;&#1103;
    </a>
  </div>
</div>

<div class="calendar-summary d-flex flex-wrap gap-2 mb-3 small">
  <span class="summary-pill summary-pill--planned">
    &#1055;&#1083;&#1072;&#1085;: {{ planned_count }}
  </span>
  <span class="summary-pill summary-pill--done">
    &#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1086;: {{ done_count }}
  </span>
  <span class="summary-pill summary-pill--overdue">
    &#1055;&#1088;&#1086;&#1089;&#1088;&#1086;&#1095;&#1077;&#1085;&#1086;: {{ overdue_count }}
  </span>
</div>

<div class="calendar-scroll">
  <div class="calendar-grid calendar-grid--header">
    <div class="calendar-weekday">&#1055;&#1085;</div>
    <div class="calendar-weekday">&#1042;&#1090;</div>
    <div class="calendar-weekday">&#1057;&#1088;</div>
    <div class="calendar-weekday">&#1063;&#1090;</div>
    <div class="calendar-weekday">&#1055;&#1090;</div>
    <div class="calendar-weekday">&#1057;&#1073;</div>
    <div class="calendar-weekday">&#1042;&#1089;</div>
  </div>

  <div class="calendar-grid calendar-grid--body">
    {% for day in calendar_days %}
      <div class="calendar-day {% if not day.is_current_month %}calendar-day--muted{% endif %} {% if day.is_today %}calendar-day--today{% endif %}" data-date="{{ day.date|date:'Y-m-d' }}" data-week-start="{{ day.week_start|date:'Y-m-d' }}">
        <div class="calendar-day__header">
          <span class="calendar-day__number">{{ day.day }}</span>
          {% if day.is_today %}
            <span class="calendar-day__badge">&#1057;&#1077;&#1075;&#1086;&#1076;&#1085;&#1103;</span>
          {% endif %}
        </div>
        <div class="calendar-day__items">
          {% for item in day.items %}
            <div class="calendar-chip calendar-chip--{{ item.status }} calendar-chip--type-{{ item.object_type }} {% if item.is_draggable %}calendar-chip--draggable{% endif %}" draggable="{{ item.is_draggable|yesno:'true,false' }}" data-pool-ids="{{ item.pool_ids|join:',' }}" data-week-start="{{ item.week_start|date:'Y-m-d' }}" data-source-week-start="{{ item.source_week_start }}" data-source-weeks="{{ item.source_weeks }}" data-source-month="{{ item.source_month }}" data-allow-month="{{ item.allow_month_move|yesno:'true,false' }}" data-date="{{ item.date|date:'Y-m-d' }}" title="{{ item.title }}">
              <span class="calendar-chip__icon" data-drag-handle="true" aria-hidden="true">
                {% if item.object_type == 'water' %}
                  <i class="bi bi-gear"></i>
                {% else %}
                  <i class="bi bi-droplet"></i>
                {% endif %}
              </span>
              <span class="calendar-chip__text">{{ item.display_name }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>

{% if paused_pools or unscheduled_pools %}
  <details class="calendar-details mt-3">
    <summary class="text-muted small">
      &#1058;&#1088;&#1077;&#1073;&#1091;&#1102;&#1090;&#1089;&#1103; &#1085;&#1072;&#1089;&#1090;&#1088;&#1086;&#1081;&#1082;&#1080; &#1087;&#1083;&#1072;&#1085;&#1072;
    </summary>
    <div class="row g-3 mt-2">
      {% if paused_pools %}
        <div class="col-12 col-lg-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="fw-semibold mb-2">&#1042;&#1099;&#1077;&#1079;&#1076;&#1099; &#1087;&#1088;&#1080;&#1086;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1083;&#1077;&#1085;&#1099;</div>
              <div class="d-flex flex-column gap-2">
                {% for pool in paused_pools %}
                  <div>
                    <a href="{% url 'pool_detail' pool.uuid %}" class="text-decoration-none fw-semibold">{{ pool.client.name }}</a>
                    <div class="text-muted small">{{ pool.address }}</div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}
      {% if unscheduled_pools %}
        <div class="col-12 col-lg-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="fw-semibold mb-2">&#1053;&#1077; &#1079;&#1072;&#1076;&#1072;&#1085;&#1072; &#1087;&#1077;&#1088;&#1080;&#1086;&#1076;&#1080;&#1095;&#1085;&#1086;&#1089;&#1090;&#1100;</div>
              <div class="d-flex flex-column gap-2">
                {% for pool in unscheduled_pools %}
                  <div>
                    <a href="{% url 'pool_detail' pool.uuid %}" class="text-decoration-none fw-semibold">{{ pool.client.name }}</a>
                    <div class="text-muted small">{{ pool.address }}</div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </details>
{% endif %}

<script>
  (function () {
    const moveUrl = "{% url 'visit_plan_move' %}";
    const chips = document.querySelectorAll(".calendar-chip--draggable");
    const days = document.querySelectorAll(".calendar-day");
    const dragHandles = document.querySelectorAll("[data-drag-handle='true']");
    let dragged = null;
    let currentDrop = null;
    let touchDrag = null;

    function getCookie(name) {
      const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      if (match) return decodeURIComponent(match[2]);
      return "";
    }

    function showMessage(text) {
      if (typeof showOfflineToast === "function") {
        showOfflineToast(text);
      } else {
        alert(text);
      }
    }

    function clearDropState() {
      if (currentDrop) {
        currentDrop.classList.remove("calendar-day--drop");
        currentDrop = null;
      }
    }

    function setDropState(day) {
      if (currentDrop === day) return;
      if (currentDrop) currentDrop.classList.remove("calendar-day--drop");
      currentDrop = day;
      if (currentDrop) currentDrop.classList.add("calendar-day--drop");
    }

    function isDropAllowed(chip, day) {
      if (!chip || !day) return false;
      const targetDate = day.dataset.date || "";
      if (!targetDate) return false;
      const allowMonth = chip.dataset.allowMonth === "true";
      const sourceMonth = chip.dataset.sourceMonth || "";
      const targetMonth = targetDate.slice(0, 7);
      if (allowMonth) {
        if (!sourceMonth) return false;
        return targetMonth === sourceMonth;
      }
      return day.dataset.weekStart === chip.dataset.weekStart;
    }

    function getDropIssueMessage(chip, day) {
      if (!chip || !day) return "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0434\u0430\u0442\u0443 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.";
      const targetDate = day.dataset.date || "";
      if (!targetDate) return "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0434\u0430\u0442\u0443 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.";
      const allowMonth = chip.dataset.allowMonth === "true";
      const sourceMonth = chip.dataset.sourceMonth || "";
      const targetMonth = targetDate.slice(0, 7);
      if (allowMonth) {
        if (!sourceMonth) {
          return "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u043c\u0435\u0441\u044f\u0446 \u043f\u043b\u0430\u043d\u0430.";
        }
        if (targetMonth !== sourceMonth) {
          return "\u041f\u0435\u0440\u0435\u043d\u043e\u0441 \u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u0440\u0435\u0434\u0435\u043b\u0430\u0445 \u044d\u0442\u043e\u0433\u043e \u043c\u0435\u0441\u044f\u0446\u0430.";
        }
      } else if (day.dataset.weekStart !== chip.dataset.weekStart) {
        return "\u041c\u043e\u0436\u043d\u043e \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0438\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u0440\u0435\u0434\u0435\u043b\u0430\u0445 \u043d\u0435\u0434\u0435\u043b\u0438.";
      }
      return "";
    }

    function buildPayload(chip, targetDate) {
      const poolIds = (chip.dataset.poolIds || "")
        .split(",")
        .map((val) => val.trim())
        .filter(Boolean);
      if (!poolIds.length) {
        showMessage("\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a \u0431\u0430\u0441\u0441\u0435\u0439\u043d\u043e\u0432 \u0434\u043b\u044f \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.");
        return null;
      }

      let sourceWeeks = {};
      if (chip.dataset.sourceWeeks) {
        try {
          sourceWeeks = JSON.parse(chip.dataset.sourceWeeks);
        } catch (e) {
          sourceWeeks = {};
        }
      }
      if (!Object.keys(sourceWeeks).length) {
        const sourceWeek = chip.dataset.sourceWeekStart || chip.dataset.weekStart;
        poolIds.forEach((pid) => {
          sourceWeeks[pid] = sourceWeek;
        });
      }

      return {
        pool_ids: poolIds,
        source_weeks: sourceWeeks,
        source_month: chip.dataset.sourceMonth || "",
        week_start: chip.dataset.weekStart,
        planned_date: targetDate,
      };
    }

    function submitMove(chip, day) {
      if (!chip || !day) return;
      const targetDate = day.dataset.date || "";
      if (!targetDate) {
        showMessage("\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0434\u0430\u0442\u0443 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.");
        return;
      }
      if (targetDate === chip.dataset.date) return;
      if (!isDropAllowed(chip, day)) {
        const message = getDropIssueMessage(chip, day);
        if (message) showMessage(message);
        return;
      }

      const payload = buildPayload(chip, targetDate);
      if (!payload) return;

      fetch(moveUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify(payload),
      })
        .then(async (response) => {
          const data = await response.json().catch(() => ({}));
          if (!response.ok || !data.ok) {
            const error = data.error || "save_failed";
            throw new Error(error);
          }
          return data;
        })
        .then(() => {
          const targetList = day.querySelector(".calendar-day__items");
          if (targetList) {
            targetList.appendChild(chip);
            chip.dataset.date = targetDate;
          }
        })
        .catch((error) => {
          if (error.message === "already_completed") {
            showMessage("\u0412\u044b\u0435\u0437\u0434 \u0443\u0436\u0435 \u043e\u0442\u043c\u0435\u0447\u0435\u043d. \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443.");
          } else if (error.message === "invalid_month") {
            showMessage("\u041f\u0435\u0440\u0435\u043d\u043e\u0441 \u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u0440\u0435\u0434\u0435\u043b\u0430\u0445 \u043c\u0435\u0441\u044f\u0446\u0430 \u043f\u043b\u0430\u043d\u0430.");
          } else if (error.message === "invalid_week") {
            showMessage("\u041f\u0435\u0440\u0435\u043d\u043e\u0441 \u0432\u043e\u0437\u043c\u043e\u0436\u0435\u043d \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u0440\u0435\u0434\u0435\u043b\u0430\u0445 \u044d\u0442\u043e\u0439 \u043d\u0435\u0434\u0435\u043b\u0438.");
          } else {
            const details = error.message ? `: ${error.message}` : "";
            showMessage(`\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0441\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u043f\u0435\u0440\u0435\u043d\u043e\u0441${details}.`);
          }
        });
    }

    chips.forEach((chip) => {
      chip.addEventListener("dragstart", (event) => {
        dragged = chip;
        chip.classList.add("calendar-chip--dragging");
        event.dataTransfer.effectAllowed = "move";
      });
      chip.addEventListener("dragend", () => {
        chip.classList.remove("calendar-chip--dragging");
        dragged = null;
        clearDropState();
      });
    });

    days.forEach((day) => {
      day.addEventListener("dragover", (event) => {
        if (!dragged) return;
        if (!isDropAllowed(dragged, day)) return;
        event.preventDefault();
        setDropState(day);
      });

      day.addEventListener("dragleave", () => {
        if (currentDrop === day) {
          setDropState(null);
        }
      });

      day.addEventListener("drop", (event) => {
        if (!dragged) return;
        event.preventDefault();
        clearDropState();
        submitMove(dragged, day);
      });
    });

    dragHandles.forEach((handle) => {
      handle.addEventListener("pointerdown", (event) => {
        const chip = handle.closest(".calendar-chip--draggable");
        if (!chip) return;
        if (event.pointerType === "mouse") return;
        event.preventDefault();
        handle.setPointerCapture?.(event.pointerId);

        dragged = chip;
        chip.classList.add("calendar-chip--dragging");

        const rect = chip.getBoundingClientRect();
        const ghost = chip.cloneNode(true);
        ghost.classList.add("calendar-chip--ghost");
        ghost.style.width = `${rect.width}px`;
        ghost.style.height = `${rect.height}px`;
        ghost.style.left = `${event.clientX}px`;
        ghost.style.top = `${event.clientY}px`;
        document.body.appendChild(ghost);

        touchDrag = {
          chip,
          ghost,
          pointerId: event.pointerId,
        };
      });

      handle.addEventListener("pointermove", (event) => {
        if (!touchDrag || touchDrag.pointerId !== event.pointerId) return;
        event.preventDefault();
        const ghost = touchDrag.ghost;
        if (ghost) {
          ghost.style.left = `${event.clientX}px`;
          ghost.style.top = `${event.clientY}px`;
        }
        const target = document.elementFromPoint(event.clientX, event.clientY);
        const day = target ? target.closest(".calendar-day") : null;
        if (day && isDropAllowed(touchDrag.chip, day)) {
          setDropState(day);
        } else {
          setDropState(null);
        }
      });

      handle.addEventListener("pointerup", (event) => {
        if (!touchDrag || touchDrag.pointerId !== event.pointerId) return;
        event.preventDefault();
        const ghost = touchDrag.ghost;
        if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
        const target = document.elementFromPoint(event.clientX, event.clientY);
        const day = target ? target.closest(".calendar-day") : null;
        clearDropState();
        submitMove(touchDrag.chip, day);

        touchDrag.chip.classList.remove("calendar-chip--dragging");
        touchDrag = null;
        dragged = null;
      });

      handle.addEventListener("pointercancel", (event) => {
        if (!touchDrag || touchDrag.pointerId !== event.pointerId) return;
        event.preventDefault();
        const ghost = touchDrag.ghost;
        if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
        clearDropState();
        touchDrag.chip.classList.remove("calendar-chip--dragging");
        touchDrag = null;
        dragged = null;
      });
    });
  })();
</script>

<style>
  .calendar-toolbar {
    background: linear-gradient(180deg, #ffffff 0%, #f6f9ff 100%);
    border: 1px solid #e6eef5;
    border-radius: 16px;
    padding: 8px 12px;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
  }
  .calendar-month-label {
    background: #f1f5ff;
    border: 1px solid #dbe5f5;
    border-radius: 999px;
    padding: 6px 12px;
    color: #1f2d3d;
  }
  .calendar-summary .summary-pill {
    border-radius: 999px;
    padding: 6px 12px;
    font-weight: 600;
  }
  .summary-pill--planned {
    background: rgba(44, 123, 229, 0.12);
    color: #2c7be5;
  }
  .summary-pill--done {
    background: rgba(31, 157, 85, 0.12);
    color: #1f9d55;
  }
  .summary-pill--overdue {
    background: rgba(229, 83, 83, 0.12);
    color: #e55353;
  }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    gap: 1px;
    background: #e6edf5;
    border-radius: 16px;
    overflow: hidden;
    min-width: 1120px;
  }
  .calendar-grid--header {
    margin-bottom: 6px;
  }
  .calendar-weekday {
    padding: 10px;
    background: #f7f9fc;
    text-align: center;
    font-weight: 600;
    color: #617085;
  }
  .calendar-grid--body {
    background: #e6edf5;
  }
  .calendar-day {
    background: #ffffff;
    min-height: 130px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    transition: background 0.2s ease;
  }
  .calendar-day--muted {
    background: #f4f6f9;
    color: #9aa6b2;
  }
  .calendar-day--muted .calendar-day__number {
    color: #9aa6b2;
  }
  .calendar-day--today {
    box-shadow: inset 0 0 0 2px rgba(44, 123, 229, 0.35);
  }
  .calendar-day--drop {
    background: #eef5ff;
  }
  .calendar-day__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .calendar-day__number {
    font-weight: 600;
    color: #1f2d3d;
  }
  .calendar-day__badge {
    font-size: 0.7rem;
    background: rgba(44, 123, 229, 0.12);
    color: #2c7be5;
    padding: 2px 6px;
    border-radius: 999px;
  }
  .calendar-day__items {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .calendar-chip {
    border-radius: 10px;
    padding: 6px 8px;
    font-size: 0.82rem;
    font-weight: 600;
    background: #eef2f7;
    color: #1f2d3d;
    border-left: 3px solid transparent;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }
  .calendar-chip__icon {
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    flex: 0 0 auto;
    touch-action: none;
  }
  .calendar-chip--type-pool .calendar-chip__icon {
    color: #2c7be5;
  }
  .calendar-chip--type-water .calendar-chip__icon {
    color: #1f9d55;
  }
  .calendar-chip__text {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }
  .calendar-chip--planned {
    background: #eef5ff;
    border-left-color: #2c7be5;
    color: #1d4f9c;
  }
  .calendar-chip--done {
    background: #f0fbf4;
    border-left-color: #1f9d55;
    color: #1f7a49;
  }
  .calendar-chip--overdue {
    background: #fff4f4;
    border-left-color: #e55353;
    color: #b12d2d;
  }
  .calendar-chip--draggable {
    cursor: grab;
  }
  .calendar-chip--dragging {
    opacity: 0.6;
  }
  .calendar-chip--ghost {
    position: fixed;
    z-index: 2000;
    pointer-events: none;
    transform: translate(-50%, -50%);
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
    opacity: 0.9;
  }
  .calendar-details summary {
    cursor: pointer;
  }
  .calendar-scroll {
    overflow-x: auto;
    overflow-y: visible;
    padding-bottom: 6px;
    -webkit-overflow-scrolling: touch;
  }
  @media (max-width: 768px) {
    .calendar-day {
      min-height: 110px;
    }
    .calendar-chip {
      font-size: 0.78rem;
    }
  }
  @media (max-width: 576px) {
    .calendar-scroll {
      margin: 0 -12px;
      padding: 0 12px 8px;
    }
    .calendar-grid {
      min-width: 1120px;
    }
    .calendar-weekday {
      font-size: 0.72rem;
      padding: 8px 4px;
    }
    .calendar-day {
      min-height: auto;
      padding: 8px;
    }
    .calendar-chip {
      font-size: 0.76rem;
    }
    .calendar-chip__text {
      white-space: normal;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
  }
</style>
{% endblock %}
