{% extends "pool_service/base.html" %}

{% block title %}&#1050;&#1072;&#1083;&#1077;&#1085;&#1076;&#1072;&#1088;&#1100; &#1079;&#1072;&#1076;&#1072;&#1095;{% endblock %}

{% block content %}
<div class="calendar-toolbar d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
  <div class="d-flex flex-wrap align-items-center gap-3">
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-light btn-sm" href="?{{ prev_month_query }}" aria-label="&#1055;&#1088;&#1077;&#1076;&#1099;&#1076;&#1091;&#1097;&#1080;&#1081; &#1084;&#1077;&#1089;&#1103;&#1094;">
        <i class="bi bi-chevron-left"></i>
      </a>
      <div class="calendar-month-label fw-semibold">{{ month_label }}</div>
      <a class="btn btn-light btn-sm" href="?{{ next_month_query }}" aria-label="&#1057;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081; &#1084;&#1077;&#1089;&#1103;&#1094;">
        <i class="bi bi-chevron-right"></i>
      </a>
    </div>
    {% if responsible_options %}
      <form class="calendar-filter calendar-filter--inline d-flex flex-wrap align-items-center gap-2" method="get">
        <input type="hidden" name="month" value="{{ current_month }}">
        <label class="form-label mb-0 small d-none d-md-block">&#1054;&#1090;&#1074;&#1077;&#1090;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1099;&#1077;</label>
        <div class="calendar-filter__field">
          <div class="multi-select" data-multi-select data-placeholder="&#1042;&#1089;&#1077; &#1086;&#1090;&#1074;&#1077;&#1090;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1099;&#1077;">
            <button type="button" class="multi-select__trigger" data-multi-select-trigger>
              <span class="multi-select__value"></span>
              <span class="multi-select__caret" aria-hidden="true">
                <i class="bi bi-chevron-down"></i>
              </span>
            </button>
            <div class="multi-select__dropdown" data-multi-select-list>
              {% for option in responsible_options %}
                <label class="multi-select__option">
                  <input type="checkbox" name="responsible" value="{{ option.id }}" {% if option.id|stringformat:"s" in selected_responsibles %}checked{% endif %}>
                  <span>{{ option.name }}</span>
                </label>
              {% empty %}
                <div class="multi-select__empty">&#1053;&#1077;&#1090; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087;&#1085;&#1099;&#1093; &#1089;&#1086;&#1090;&#1088;&#1091;&#1076;&#1085;&#1080;&#1082;&#1086;&#1074;.</div>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="calendar-filter__actions d-flex gap-2">
          <button class="btn btn-primary btn-sm" type="submit">&#1055;&#1088;&#1080;&#1084;&#1077;&#1085;&#1080;&#1090;&#1100;</button>
          <a class="btn btn-outline-secondary btn-sm" href="?month={{ current_month }}">&#1057;&#1073;&#1088;&#1086;&#1089;&#1080;&#1090;&#1100;</a>
        </div>
      </form>
    {% endif %}
  </div>
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="?{{ today_month_query }}">
      &#1057;&#1077;&#1075;&#1086;&#1076;&#1085;&#1103;
    </a>
  </div>
</div>

<div class="calendar-summary d-flex flex-wrap gap-2 mb-3 small">
  <span class="summary-pill summary-pill--planned">
    &#1055;&#1083;&#1072;&#1085;: {{ planned_count }}
  </span>
  <span class="summary-pill summary-pill--done">
    &#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1086;: {{ done_count }}
  </span>
  <span class="summary-pill summary-pill--overdue">
    &#1055;&#1088;&#1086;&#1089;&#1088;&#1086;&#1095;&#1077;&#1085;&#1086;: {{ overdue_count }}
  </span>
</div>

<div class="calendar-scroll">
  <div class="calendar-grid calendar-grid--header">
    <div class="calendar-weekday">&#1055;&#1085;</div>
    <div class="calendar-weekday">&#1042;&#1090;</div>
    <div class="calendar-weekday">&#1057;&#1088;</div>
    <div class="calendar-weekday">&#1063;&#1090;</div>
    <div class="calendar-weekday">&#1055;&#1090;</div>
    <div class="calendar-weekday">&#1057;&#1073;</div>
    <div class="calendar-weekday">&#1042;&#1089;</div>
  </div>

  <div class="calendar-grid calendar-grid--body">
    {% for day in calendar_days %}
      <div class="calendar-day {% if not day.is_current_month %}calendar-day--muted{% endif %} {% if day.is_today %}calendar-day--today{% endif %}" data-date="{{ day.date|date:'Y-m-d' }}" data-week-start="{{ day.week_start|date:'Y-m-d' }}"{% if can_create_tasks %} data-create-url="{% url 'task_create' %}?date={{ day.date|date:'Y-m-d' }}&next={{ calendar_return_url|urlencode }}"{% endif %}>
        <div class="calendar-day__header">
          <span class="calendar-day__number">{{ day.day }}</span>
          <div class="calendar-day__meta">
            {% if day.is_today %}
              <span class="calendar-day__badge">&#1057;&#1077;&#1075;&#1086;&#1076;&#1085;&#1103;</span>
            {% endif %}
            {% if can_create_tasks %}
              <a class="calendar-day__add" href="{% url 'task_create' %}?date={{ day.date|date:'Y-m-d' }}&next={{ calendar_return_url|urlencode }}" data-task-modal-url="{% url 'task_create' %}?date={{ day.date|date:'Y-m-d' }}&next={{ calendar_return_url|urlencode }}" aria-label="&#1044;&#1086;&#1073;&#1072;&#1074;&#1080;&#1090;&#1100; &#1079;&#1072;&#1076;&#1072;&#1095;&#1091;">
                <i class="bi bi-plus"></i>
              </a>
            {% endif %}
          </div>
        </div>
        <div class="calendar-day__items">
          {% for item in day.items %}
            {% if forloop.counter0 == 7 %}
              <div class="calendar-day__extra d-none">
            {% endif %}
            {% if item.item_type == "task_continuation" %}
              <div class="calendar-chip calendar-chip--continuation calendar-chip--{{ item.status }} calendar-chip--priority-{{ item.priority }} {% if item.is_completed or item.status == 'done' %}calendar-chip--completed{% endif %}" title="{{ item.title }}">
                <span class="calendar-chip__text">&#8594; {{ item.display_name }}</span>
              </div>
            {% elif item.item_type == "task" %}
              {% if item.edit_url %}
                <a class="calendar-chip calendar-chip--task calendar-chip--{{ item.status }} calendar-chip--priority-{{ item.priority }} {% if item.is_completed or item.status == 'done' %}calendar-chip--completed{% endif %} calendar-chip--link {% if item.is_draggable %}calendar-chip--draggable calendar-chip--task-draggable{% endif %}" href="{{ item.edit_url }}" data-task-modal-url="{{ item.edit_url }}" draggable="{{ item.is_draggable|yesno:'true,false' }}" data-task-id="{{ item.task_id }}" data-task-start="{{ item.start_date|date:'Y-m-d' }}" data-task-end="{{ item.end_date|date:'Y-m-d' }}" data-date="{{ item.date|date:'Y-m-d' }}" title="{{ item.title }}">
              {% else %}
                <div class="calendar-chip calendar-chip--task calendar-chip--{{ item.status }} calendar-chip--priority-{{ item.priority }} {% if item.is_completed or item.status == 'done' %}calendar-chip--completed{% endif %}" title="{{ item.title }}">
              {% endif %}
                  <span class="calendar-chip__icon" data-drag-handle="true" aria-hidden="true">
                    <i class="bi bi-list-check"></i>
                  </span>
                  <span class="calendar-chip__text">
                    {{ item.display_name }}
                    {% if item.is_multi %}
                      <span class="calendar-chip__badge">{{ item.span_days }} &#1076;&#1085;</span>
                    {% endif %}
                    {% if item.is_continued %}
                      <span class="calendar-chip__badge calendar-chip__badge--ghost">&#1087;&#1088;&#1086;&#1076;.</span>
                    {% endif %}
                  </span>
                  <span class="calendar-chip__priority calendar-chip__priority--{{ item.priority }}" aria-hidden="true"></span>
              {% if item.edit_url %}
                </a>
              {% else %}
                </div>
              {% endif %}
            {% else %}
              <div class="calendar-chip calendar-chip--{{ item.status }} calendar-chip--type-{{ item.object_type }} {% if item.is_draggable %}calendar-chip--draggable{% endif %} {% if item.status == 'done' %}calendar-chip--completed{% endif %}" draggable="{{ item.is_draggable|yesno:'true,false' }}" data-pool-ids="{{ item.pool_ids|join:',' }}" data-week-start="{{ item.week_start|date:'Y-m-d' }}" data-source-week-start="{{ item.source_week_start }}" data-source-weeks="{{ item.source_weeks }}" data-source-month="{{ item.source_month }}" data-allow-month="{{ item.allow_month_move|yesno:'true,false' }}" data-date="{{ item.date|date:'Y-m-d' }}" title="{{ item.title }}">
                <span class="calendar-chip__icon" data-drag-handle="true" aria-hidden="true">
                  {% if item.object_type == 'water' %}
                    <i class="bi bi-gear"></i>
                  {% else %}
                    <i class="bi bi-droplet"></i>
                  {% endif %}
                </span>
                <span class="calendar-chip__text">{{ item.display_name }}</span>
              </div>
            {% endif %}
            {% if forloop.last and forloop.counter0 >= 7 %}
              </div>
            {% endif %}
          {% endfor %}
          {% if day.items|length > 7 %}
            {% with extra_count=day.items|length|add:"-7" %}
              <button type="button" class="calendar-day__more" data-more-toggle data-more-count="{{ extra_count }}">
                &#1045;&#1097;&#1077; {{ extra_count }} &#1079;&#1072;&#1076;&#1072;&#1095;
              </button>
            {% endwith %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>

{% if paused_pools or unscheduled_pools %}
  <details class="calendar-details mt-3">
    <summary class="text-muted small">
      &#1058;&#1088;&#1077;&#1073;&#1091;&#1102;&#1090;&#1089;&#1103; &#1085;&#1072;&#1089;&#1090;&#1088;&#1086;&#1081;&#1082;&#1080; &#1087;&#1083;&#1072;&#1085;&#1072;
    </summary>
    <div class="row g-3 mt-2">
      {% if paused_pools %}
        <div class="col-12 col-lg-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="fw-semibold mb-2">&#1042;&#1099;&#1077;&#1079;&#1076;&#1099; &#1087;&#1088;&#1080;&#1086;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1083;&#1077;&#1085;&#1099;</div>
              <div class="d-flex flex-column gap-2">
                {% for pool in paused_pools %}
                  <div>
                    <a href="{% url 'pool_detail' pool.uuid %}" class="text-decoration-none fw-semibold">{{ pool.client.name }}</a>
                    <div class="text-muted small">{{ pool.address }}</div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}
      {% if unscheduled_pools %}
        <div class="col-12 col-lg-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="fw-semibold mb-2">&#1053;&#1077; &#1079;&#1072;&#1076;&#1072;&#1085;&#1072; &#1087;&#1077;&#1088;&#1080;&#1086;&#1076;&#1080;&#1095;&#1085;&#1086;&#1089;&#1090;&#1100;</div>
              <div class="d-flex flex-column gap-2">
                {% for pool in unscheduled_pools %}
                  <div>
                    <a href="{% url 'pool_detail' pool.uuid %}" class="text-decoration-none fw-semibold">{{ pool.client.name }}</a>
                    <div class="text-muted small">{{ pool.address }}</div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </details>
{% endif %}

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
    <div class="modal-content task-modal__content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskModalTitle">&#1047;&#1072;&#1076;&#1072;&#1095;&#1072;</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="&#1047;&#1072;&#1082;&#1088;&#1099;&#1090;&#1100;"></button>
      </div>
      <div class="modal-body task-modal__body">
        <div class="task-modal__loading d-flex align-items-center gap-2 text-muted">
          <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
          <span>&#1047;&#1072;&#1075;&#1088;&#1091;&#1079;&#1082;&#1072;...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const autoMoveUrl = "{% url 'visit_plan_move' %}";
    const taskMoveUrl = "{% url 'task_move' %}";
    const chips = document.querySelectorAll(".calendar-chip--draggable");
    const days = document.querySelectorAll(".calendar-day");
    const dragHandles = document.querySelectorAll("[data-drag-handle='true']");
    const taskModalEl = document.getElementById("taskModal");
    const taskModalTitle = taskModalEl ? taskModalEl.querySelector("#taskModalTitle") : null;
    const taskModalBody = taskModalEl ? taskModalEl.querySelector(".task-modal__body") : null;
    const canUseBootstrap = taskModalEl && window.bootstrap && typeof window.bootstrap.Modal === "function";
    let fallbackBackdrop = null;
    function createFallbackModal(modalEl) {
      return {
        show() {
          if (!modalEl) return;
          modalEl.style.display = "block";
          modalEl.classList.add("show");
          modalEl.removeAttribute("aria-hidden");
          modalEl.setAttribute("aria-modal", "true");
          document.body.classList.add("modal-open");
          if (!fallbackBackdrop) {
            fallbackBackdrop = document.createElement("div");
            fallbackBackdrop.className = "modal-backdrop fade show";
            document.body.appendChild(fallbackBackdrop);
          }
        },
        hide() {
          if (!modalEl) return;
          modalEl.classList.remove("show");
          modalEl.style.display = "none";
          modalEl.setAttribute("aria-hidden", "true");
          modalEl.removeAttribute("aria-modal");
          document.body.classList.remove("modal-open");
          if (fallbackBackdrop) {
            fallbackBackdrop.remove();
            fallbackBackdrop = null;
          }
          showTaskLoading();
        },
      };
    }
    const taskModal = taskModalEl
      ? canUseBootstrap
        ? new bootstrap.Modal(taskModalEl)
        : createFallbackModal(taskModalEl)
      : null;
    let dragged = null;
    let currentDrop = null;
    let touchDrag = null;

    function getCookie(name) {
      const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      if (match) return decodeURIComponent(match[2]);
      return "";
    }

    function showMessage(text) {
      if (typeof showOfflineToast === "function") {
        showOfflineToast(text);
      } else {
        alert(text);
      }
    }

    function isTaskChip(chip) {
      return Boolean(chip && chip.dataset.taskId);
    }

    function showTaskLoading() {
      if (!taskModalBody) return;
      if (taskModalTitle) {
        taskModalTitle.textContent = "\u0417\u0430\u0434\u0430\u0447\u0430";
      }
      taskModalBody.innerHTML = `
        <div class="task-modal__loading d-flex align-items-center gap-2 text-muted">
          <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
          <span>\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430...</span>
        </div>
      `;
    }

    function appendModalParam(url) {
      if (!url) return url;
      if (url.includes("modal=1")) return url;
      const divider = url.includes("?") ? "&" : "?";
      return `${url}${divider}modal=1`;
    }

    function openTaskModal(url) {
      if (!url) return;
      if (!taskModalEl || !taskModalBody || !taskModal) {
        window.location.href = url;
        return;
      }
      showTaskLoading();
      taskModal.show();
      const modalUrl = appendModalParam(url);
      fetch(modalUrl, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
        cache: "no-store",
        credentials: "same-origin",
      })
        .then((resp) => resp.text())
        .then((html) => {
          taskModalBody.innerHTML = html;
          const root = taskModalBody.querySelector(".task-modal");
          if (root && root.dataset.modalTitle && taskModalTitle) {
            taskModalTitle.textContent = root.dataset.modalTitle;
          }
          if (window.initAllMultiSelects) {
            window.initAllMultiSelects(taskModalBody);
          }
          if (window.initTaskForms) {
            window.initTaskForms(taskModalBody);
          }
        })
        .catch(() => {
          taskModalBody.innerHTML = `
            <div class="text-danger">
              \u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0444\u043e\u0440\u043c\u0443.
            </div>
          `;
        });
    }

    if (taskModalEl && taskModal) {
      taskModalEl.addEventListener("submit", (event) => {
        const form = event.target.closest("[data-task-form]");
        if (!form) return;
        event.preventDefault();
        const formData = new FormData(form);
        if (!formData.has("modal")) {
          formData.append("modal", "1");
        }
        fetch(form.action, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: formData,
          credentials: "same-origin",
        })
          .then(async (resp) => {
            const contentType = resp.headers.get("content-type") || "";
            if (contentType.includes("application/json")) {
              const data = await resp.json().catch(() => ({}));
              if (!resp.ok || !data.ok) {
                const error = data.error || "save_failed";
                throw new Error(error);
              }
              return { ok: true };
            }
            const html = await resp.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const formNode = doc.querySelector("[data-task-form]");
            if (formNode) {
              taskModalBody.innerHTML = html;
              if (window.initAllMultiSelects) {
                window.initAllMultiSelects(taskModalBody);
              }
              if (window.initTaskForms) {
                window.initTaskForms(taskModalBody);
              }
              return { ok: false };
            }
            const message = resp.ok
              ? "\u041e\u0448\u0438\u0431\u043a\u0430 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f. \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \u0438 \u043f\u043e\u0432\u0442\u043e\u0440\u0438\u0442\u0435."
              : "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0441\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0437\u0430\u0434\u0430\u0447\u0443. \u041f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435 \u0434\u0430\u043d\u043d\u044b\u0435.";
            showMessage(message);
            return { ok: false };
          })
          .then((result) => {
            if (result && result.ok) {
              taskModal.hide();
              window.location.reload();
            }
          })
          .catch((error) => {
            const details = error.message ? `: ${error.message}` : "";
            showMessage(`\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0441\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0437\u0430\u0434\u0430\u0447\u0443${details}.`);
          });
      });

      if (canUseBootstrap) {
        taskModalEl.addEventListener("hidden.bs.modal", () => {
          showTaskLoading();
        });
      } else {
        taskModalEl.addEventListener("click", (event) => {
          if (event.target.closest("[data-bs-dismiss='modal']")) {
            event.preventDefault();
            taskModal.hide();
            return;
          }
          if (event.target === taskModalEl) {
            taskModal.hide();
          }
        });
      }
    }

    document.addEventListener("click", (event) => {
      if (dragged || touchDrag) return;
      const trigger = event.target.closest("[data-task-modal-url]");
      if (!trigger) return;
      const hasButton = typeof event.button === "number";
      if (event.defaultPrevented || (hasButton && event.button !== 0) || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
        return;
      }
      event.preventDefault();
      const url = trigger.dataset.taskModalUrl || trigger.getAttribute("href");
      if (url) openTaskModal(url);
    });

    function clearDropState() {
      if (currentDrop) {
        currentDrop.classList.remove("calendar-day--drop");
        currentDrop = null;
      }
    }

    function setDropState(day) {
      if (currentDrop === day) return;
      if (currentDrop) currentDrop.classList.remove("calendar-day--drop");
      currentDrop = day;
      if (currentDrop) currentDrop.classList.add("calendar-day--drop");
    }

    function isDropAllowed(chip, day) {
      if (!chip || !day) return false;
      const targetDate = day.dataset.date || "";
      if (!targetDate) return false;
      if (isTaskChip(chip)) return true;
      const allowMonth = chip.dataset.allowMonth === "true";
      const sourceMonth = chip.dataset.sourceMonth || "";
      const targetMonth = targetDate.slice(0, 7);
      if (allowMonth) {
        if (!sourceMonth) return false;
        return targetMonth === sourceMonth;
      }
      return day.dataset.weekStart === chip.dataset.weekStart;
    }

    function getDropIssueMessage(chip, day) {
      if (!chip || !day) return "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0434\u0430\u0442\u0443 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.";
      const targetDate = day.dataset.date || "";
      if (!targetDate) return "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0434\u0430\u0442\u0443 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.";
      const allowMonth = chip.dataset.allowMonth === "true";
      const sourceMonth = chip.dataset.sourceMonth || "";
      const targetMonth = targetDate.slice(0, 7);
      if (allowMonth) {
        if (!sourceMonth) {
          return "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u043c\u0435\u0441\u044f\u0446 \u043f\u043b\u0430\u043d\u0430.";
        }
        if (targetMonth !== sourceMonth) {
          return "\u041f\u0435\u0440\u0435\u043d\u043e\u0441 \u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u0440\u0435\u0434\u0435\u043b\u0430\u0445 \u044d\u0442\u043e\u0433\u043e \u043c\u0435\u0441\u044f\u0446\u0430.";
        }
      } else if (day.dataset.weekStart !== chip.dataset.weekStart) {
        return "\u041c\u043e\u0436\u043d\u043e \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0438\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u0440\u0435\u0434\u0435\u043b\u0430\u0445 \u043d\u0435\u0434\u0435\u043b\u0438.";
      }
      return "";
    }

    function buildAutoPayload(chip, targetDate) {
      const poolIds = (chip.dataset.poolIds || "")
        .split(",")
        .map((val) => val.trim())
        .filter(Boolean);
      if (!poolIds.length) {
        showMessage("\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a \u0431\u0430\u0441\u0441\u0435\u0439\u043d\u043e\u0432 \u0434\u043b\u044f \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.");
        return null;
      }

      let sourceWeeks = {};
      if (chip.dataset.sourceWeeks) {
        try {
          sourceWeeks = JSON.parse(chip.dataset.sourceWeeks);
        } catch (e) {
          sourceWeeks = {};
        }
      }
      if (!Object.keys(sourceWeeks).length) {
        const sourceWeek = chip.dataset.sourceWeekStart || chip.dataset.weekStart;
        poolIds.forEach((pid) => {
          sourceWeeks[pid] = sourceWeek;
        });
      }

      return {
        pool_ids: poolIds,
        source_weeks: sourceWeeks,
        source_month: chip.dataset.sourceMonth || "",
        week_start: chip.dataset.weekStart,
        planned_date: targetDate,
      };
    }

    function buildTaskPayload(chip, targetDate) {
      const taskId = chip.dataset.taskId || "";
      if (!taskId) {
        showMessage("\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0437\u0430\u0434\u0430\u0447\u0443.");
        return null;
      }
      return {
        task_id: taskId,
        target_date: targetDate,
      };
    }

    function handleTaskMove(chip, targetDate) {
      const payload = buildTaskPayload(chip, targetDate);
      if (!payload) return;
      fetch(taskMoveUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify(payload),
      })
        .then(async (response) => {
          const data = await response.json().catch(() => ({}));
          if (!response.ok || !data.ok) {
            const error = data.error || "save_failed";
            throw new Error(error);
          }
          return data;
        })
        .then(() => {
          window.location.reload();
        })
        .catch((error) => {
          const errorMap = {
            forbidden: "\u041d\u0435\u0442 \u043f\u0440\u0430\u0432 \u0434\u043b\u044f \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430 \u0437\u0430\u0434\u0430\u0447\u0438.",
            invalid_task: "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0437\u0430\u0434\u0430\u0447\u0443.",
            invalid_date: "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0434\u0430\u0442\u0443 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.",
            missing_fields: "\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0434\u0430\u0442\u0443 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.",
            completed_task: "\u0417\u0430\u043a\u0440\u044b\u0442\u0443\u044e \u0437\u0430\u0434\u0430\u0447\u0443 \u043d\u0435\u043b\u044c\u0437\u044f \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0438\u0442\u044c.",
          };
          const message = errorMap[error.message];
          if (message) {
            showMessage(message);
            return;
          }
          const details = error.message ? `: ${error.message}` : "";
          showMessage(`\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0441\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u043f\u0435\u0440\u0435\u043d\u043e\u0441 \u0437\u0430\u0434\u0430\u0447\u0438${details}.`);
        });
    }

    function submitMove(chip, day) {
      if (!chip || !day) return;
      const targetDate = day.dataset.date || "";
      if (!targetDate) {
        showMessage("\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u0442\u044c \u0434\u0430\u0442\u0443 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u0430.");
        return;
      }
      if (targetDate === chip.dataset.date) return;
      if (isTaskChip(chip)) {
        handleTaskMove(chip, targetDate);
        return;
      }
      if (!isDropAllowed(chip, day)) {
        const message = getDropIssueMessage(chip, day);
        if (message) showMessage(message);
        return;
      }

      const payload = buildAutoPayload(chip, targetDate);
      if (!payload) return;

      fetch(autoMoveUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify(payload),
      })
        .then(async (response) => {
          const data = await response.json().catch(() => ({}));
          if (!response.ok || !data.ok) {
            const error = data.error || "save_failed";
            throw new Error(error);
          }
          return data;
        })
        .then(() => {
          const targetList = day.querySelector(".calendar-day__items");
          if (targetList && chip && chip.nodeType === 1) {
            targetList.appendChild(chip);
            chip.dataset.date = targetDate;
          }
        })
        .catch((error) => {
          if (error.message === "already_completed") {
            showMessage("\u0412\u044b\u0435\u0437\u0434 \u0443\u0436\u0435 \u043e\u0442\u043c\u0435\u0447\u0435\u043d. \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443.");
          } else if (error.message === "invalid_month") {
            showMessage("\u041f\u0435\u0440\u0435\u043d\u043e\u0441 \u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u0440\u0435\u0434\u0435\u043b\u0430\u0445 \u043c\u0435\u0441\u044f\u0446\u0430 \u043f\u043b\u0430\u043d\u0430.");
          } else if (error.message === "invalid_week") {
            showMessage("\u041f\u0435\u0440\u0435\u043d\u043e\u0441 \u0432\u043e\u0437\u043c\u043e\u0436\u0435\u043d \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u0440\u0435\u0434\u0435\u043b\u0430\u0445 \u044d\u0442\u043e\u0439 \u043d\u0435\u0434\u0435\u043b\u0438.");
          } else {
            const details = error.message ? `: ${error.message}` : "";
            showMessage(`\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0441\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u043f\u0435\u0440\u0435\u043d\u043e\u0441${details}.`);
          }
        });
    }

    chips.forEach((chip) => {
      chip.addEventListener("dragstart", (event) => {
        dragged = chip;
        chip.classList.add("calendar-chip--dragging");
        if (event.dataTransfer) {
          event.dataTransfer.effectAllowed = "move";
          event.dataTransfer.setData("text/plain", "");
        }
      });
      chip.addEventListener("dragend", () => {
        chip.classList.remove("calendar-chip--dragging");
        dragged = null;
        clearDropState();
      });
    });

    days.forEach((day) => {
      day.addEventListener("dragover", (event) => {
        if (!dragged) return;
        event.preventDefault();
        if (isDropAllowed(dragged, day)) {
          setDropState(day);
        } else {
          setDropState(null);
        }
      });

      day.addEventListener("dragleave", () => {
        if (currentDrop === day) {
          setDropState(null);
        }
      });

      day.addEventListener("drop", (event) => {
        if (!dragged) return;
        event.preventDefault();
        clearDropState();
        submitMove(dragged, day);
      });
    });

    dragHandles.forEach((handle) => {
      handle.addEventListener("pointerdown", (event) => {
        const chip = handle.closest(".calendar-chip--draggable");
        if (!chip) return;
        if (event.pointerType === "mouse") return;
        event.preventDefault();
        handle.setPointerCapture?.(event.pointerId);

        dragged = chip;
        chip.classList.add("calendar-chip--dragging");

        const rect = chip.getBoundingClientRect();
        const ghost = chip.cloneNode(true);
        ghost.classList.add("calendar-chip--ghost");
        ghost.style.width = `${rect.width}px`;
        ghost.style.height = `${rect.height}px`;
        ghost.style.left = `${event.clientX}px`;
        ghost.style.top = `${event.clientY}px`;
        document.body.appendChild(ghost);

        touchDrag = {
          chip,
          ghost,
          pointerId: event.pointerId,
        };
      });

      handle.addEventListener("pointermove", (event) => {
        if (!touchDrag || touchDrag.pointerId !== event.pointerId) return;
        event.preventDefault();
        const ghost = touchDrag.ghost;
        if (ghost) {
          ghost.style.left = `${event.clientX}px`;
          ghost.style.top = `${event.clientY}px`;
        }
        const target = document.elementFromPoint(event.clientX, event.clientY);
        const day = target ? target.closest(".calendar-day") : null;
        if (day && isDropAllowed(touchDrag.chip, day)) {
          setDropState(day);
        } else {
          setDropState(null);
        }
      });

      handle.addEventListener("pointerup", (event) => {
        if (!touchDrag || touchDrag.pointerId !== event.pointerId) return;
        event.preventDefault();
        const ghost = touchDrag.ghost;
        if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
        const target = document.elementFromPoint(event.clientX, event.clientY);
        const day = target ? target.closest(".calendar-day") : null;
        clearDropState();
        submitMove(touchDrag.chip, day);

        touchDrag.chip.classList.remove("calendar-chip--dragging");
        touchDrag = null;
        dragged = null;
      });

      handle.addEventListener("pointercancel", (event) => {
        if (!touchDrag || touchDrag.pointerId !== event.pointerId) return;
        event.preventDefault();
        const ghost = touchDrag.ghost;
        if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
        clearDropState();
        touchDrag.chip.classList.remove("calendar-chip--dragging");
        touchDrag = null;
        dragged = null;
      });
    });

    days.forEach((day) => {
      day.addEventListener("click", (event) => {
        if (dragged || touchDrag) return;
        if (event.target.closest(".calendar-chip")) return;
        if (event.target.closest(".calendar-day__add")) return;
        if (event.target.closest(".calendar-day__more")) return;
        const url = day.dataset.createUrl;
        if (url) {
          openTaskModal(url);
        }
      });
    });

    document.addEventListener("click", (event) => {
      const toggle = event.target.closest("[data-more-toggle]");
      if (!toggle) return;
      event.preventDefault();
      const day = toggle.closest(".calendar-day");
      const extra = day ? day.querySelector(".calendar-day__extra") : null;
      if (!extra) return;
      extra.classList.toggle("d-none");
      const expanded = !extra.classList.contains("d-none");
      const count = toggle.dataset.moreCount || "";
      toggle.textContent = expanded ? "\u0421\u0432\u0435\u0440\u043d\u0443\u0442\u044c" : `\u0415\u0449\u0435 ${count} \u0437\u0430\u0434\u0430\u0447`;
    });
  });
</script>

<style>
  .calendar-toolbar {
    background: linear-gradient(180deg, #ffffff 0%, #f6f9ff 100%);
    border: 1px solid #e6eef5;
    border-radius: 16px;
    padding: 8px 12px;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
  }
  .calendar-month-label {
    background: #f1f5ff;
    border: 1px solid #dbe5f5;
    border-radius: 999px;
    padding: 6px 12px;
    color: #1f2d3d;
  }
  .calendar-summary .summary-pill {
    border-radius: 999px;
    padding: 6px 12px;
    font-weight: 600;
  }
  .calendar-filter {
    background: #ffffff;
    border: 1px solid #e6eef5;
    border-radius: 14px;
    padding: 10px 12px;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
  }
  .calendar-filter--inline {
    background: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
  }
  .calendar-filter__field {
    min-width: 220px;
  }
  .calendar-filter__field .form-select {
    min-height: 44px;
  }
  .summary-pill--planned {
    background: rgba(44, 123, 229, 0.12);
    color: #2c7be5;
  }
  .summary-pill--done {
    background: rgba(31, 157, 85, 0.12);
    color: #1f9d55;
  }
  .summary-pill--overdue {
    background: rgba(229, 83, 83, 0.12);
    color: #e55353;
  }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    gap: 1px;
    background: #e6edf5;
    border-radius: 16px;
    overflow: hidden;
    min-width: 1120px;
  }
  .calendar-grid--header {
    margin-bottom: 6px;
  }
  .calendar-weekday {
    padding: 10px;
    background: #f7f9fc;
    text-align: center;
    font-weight: 600;
    color: #617085;
  }
  .calendar-grid--body {
    background: #e6edf5;
  }
  .calendar-day {
    background: #ffffff;
    min-height: 130px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    transition: background 0.2s ease;
  }
  .calendar-day--muted {
    background: #f4f6f9;
    color: #9aa6b2;
  }
  .calendar-day--muted .calendar-day__number {
    color: #9aa6b2;
  }
  .calendar-day--today {
    box-shadow: inset 0 0 0 2px rgba(44, 123, 229, 0.35);
  }
  .calendar-day--drop {
    background: #eef5ff;
  }
  .calendar-day__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .calendar-day__meta {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .calendar-day__number {
    font-weight: 600;
    color: #1f2d3d;
  }
  .calendar-day__badge {
    font-size: 0.7rem;
    background: rgba(44, 123, 229, 0.12);
    color: #2c7be5;
    padding: 2px 6px;
    border-radius: 999px;
  }
  .calendar-day__add {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 1px solid #d7e2f1;
    color: #2c7be5;
    background: #f3f7ff;
    text-decoration: none;
    font-size: 0.8rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .calendar-day__add:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(44, 123, 229, 0.2);
  }
  .calendar-day__items {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .calendar-day__extra {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 2px;
  }
  .calendar-day__more {
    margin-top: 2px;
    padding: 4px 8px;
    border-radius: 10px;
    border: 1px dashed #c9d6e6;
    background: #f3f7ff;
    color: #2c7be5;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: left;
  }
  .calendar-chip {
    border-radius: 10px;
    padding: 6px 8px;
    font-size: 0.82rem;
    font-weight: 600;
    background: #eef2f7;
    color: #1f2d3d;
    border-left: 3px solid transparent;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }
  .calendar-chip--link {
    text-decoration: none;
    color: inherit;
  }
  .calendar-chip__icon {
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    flex: 0 0 auto;
    touch-action: none;
  }
  .calendar-chip__badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 1px 6px;
    border-radius: 999px;
    background: rgba(31, 45, 61, 0.1);
    color: #1f2d3d;
    font-size: 0.65rem;
    font-weight: 700;
    margin-left: 6px;
  }
  .calendar-chip__badge--ghost {
    background: rgba(44, 123, 229, 0.12);
    color: #2c7be5;
  }
  .calendar-chip__priority {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: auto;
    flex: 0 0 auto;
  }
  .calendar-chip__priority--low {
    background: #9aa6b2;
  }
  .calendar-chip__priority--normal {
    background: #2c7be5;
  }
  .calendar-chip__priority--high {
    background: #e55353;
  }
  .calendar-chip--type-pool .calendar-chip__icon {
    color: #2c7be5;
  }
  .calendar-chip--type-water .calendar-chip__icon {
    color: #1f9d55;
  }
  .calendar-chip__text {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }
  .calendar-chip--planned {
    background: #eef5ff;
    border-left-color: #2c7be5;
    color: #1d4f9c;
  }
  .calendar-chip--done {
    background: #f0fbf4;
    border-left-color: #1f9d55;
    color: #1f7a49;
  }
  .calendar-chip--overdue {
    background: #fff4f4;
    border-left-color: #e55353;
    color: #b12d2d;
  }
  .calendar-chip--task.calendar-chip--planned {
    background: #f2f5ff;
  }
  .calendar-chip--task.calendar-chip--overdue {
    background: #ffecec;
  }
  .calendar-chip--task.calendar-chip--done {
    background: #eefaf4;
  }
  .calendar-chip--continuation {
    font-size: 0.74rem;
    padding: 4px 8px;
    border-left-style: dashed;
    opacity: 0.85;
  }
  .calendar-chip--draggable {
    cursor: grab;
  }
  .calendar-chip__icon[data-drag-handle='true'] {
    cursor: grab;
  }
  .calendar-chip__icon[data-drag-handle='true']:active {
    cursor: grabbing;
  }
  .calendar-chip--dragging {
    opacity: 0.6;
  }
  .calendar-chip--completed {
    text-decoration: line-through;
    opacity: 0.7;
  }
  .calendar-chip--ghost {
    position: fixed;
    z-index: 2000;
    pointer-events: none;
    transform: translate(-50%, -50%);
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
    opacity: 0.9;
  }
  .calendar-details summary {
    cursor: pointer;
  }
  .calendar-scroll {
    overflow-x: auto;
    overflow-y: visible;
    padding-bottom: 6px;
    -webkit-overflow-scrolling: touch;
  }
  @media (max-width: 768px) {
    .calendar-day {
      min-height: 110px;
    }
    .calendar-chip {
      font-size: 0.78rem;
    }
    .calendar-filter {
      width: 100%;
    }
  }
  @media (max-width: 576px) {
    .calendar-scroll {
      margin: 0 -12px;
      padding: 0 12px 8px;
    }
    .calendar-grid {
      min-width: 1120px;
    }
    .calendar-weekday {
      font-size: 0.72rem;
      padding: 8px 4px;
    }
    .calendar-day {
      min-height: auto;
      padding: 8px;
    }
    .calendar-chip {
      font-size: 0.76rem;
    }
    .calendar-chip__text {
      white-space: normal;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
  }
</style>
{% endblock %}
