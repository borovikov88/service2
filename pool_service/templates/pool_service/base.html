{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}{{ brand_name }}{% endblock %}</title>
  <meta name="theme-color" content="#f7f9fc" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  {% if not allow_indexing %}
  <meta name="robots" content="noindex, nofollow" />
  {% endif %}

  <link rel="icon" type="image/png" href="{% static brand_favicon %}" />
  <link rel="manifest" href="{% url 'manifest' %}">
  <link rel="apple-touch-icon" href="{% static brand_icon_192 %}">
  <meta name="apple-mobile-web-app-title" content="{{ brand_name }}" />
  <meta name="application-name" content="{{ brand_name }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="{% static 'assets/css/style.css' %}" rel="stylesheet" />

  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
    (function (m, e, t, r, i, k, a) {
      m[i] =
        m[i] ||
        function () {
          (m[i].a = m[i].a || []).push(arguments);
        };
      m[i].l = 1 * new Date();
      for (var j = 0; j < document.scripts.length; j++) {
        if (document.scripts[j].src === r) {
          return;
        }
      }
      k = e.createElement(t);
      a = e.getElementsByTagName(t)[0];
      k.async = 1;
      k.src = r;
      a.parentNode.insertBefore(k, a);
    })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js?id=106179770", "ym");

    ym(106179770, "init", {
      ssr: true,
      webvisor: true,
      clickmap: true,
      ecommerce: "dataLayer",
      accurateTrackBounce: true,
      trackLinks: true,
    });
  </script>
  <!-- /Yandex.Metrika counter -->

  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    :root {
      --app-bg-start: #f8fbff;
      --app-bg-end: #dbe7f6;
      --app-header-bg: #f7f9fc;
      --bottom-nav-bg: rgba(255, 255, 255, 0.9);
      --menu-bg-start: #eef3ff;
      --menu-bg-end: #dbe7f6;
      --menu-item-bg: rgba(255, 255, 255, 0.75);
      --menu-item-hover: rgba(255, 255, 255, 0.95);
    }

    body {
      background: linear-gradient(180deg, var(--app-bg-start) 0%, #f1f6ff 58%, var(--app-bg-end) 100%);
      min-height: 100vh;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      color: #1f2d3d;
      margin: 0;
    }

    .app-header {
      background: var(--app-header-bg);
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.08);
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .header-icon {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: none;
      background: transparent;
      color: #5f6f82;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .header-icon:hover {
      color: #1f2d3d;
    }

    .nav-link-button {
      background: none;
      border: none;
      padding: 0;
      color: inherit;
      font: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    .app-logo {
      height: 40px;
      width: auto;
      max-width: 160px;
      object-fit: contain;
      display: block;
    }

    .app-logo--compact {
      height: 34px;
      max-width: 140px;
    }

    .app-logo--wide {
      height: 44px;
      max-width: 240px;
    }

    .app-logo--wide.app-logo--compact {
      height: 36px;
      max-width: 200px;
    }

    @media (max-width: 576px) {
      .app-logo--wide {
        height: 44px;
        max-width: 200px;
      }
    }

    :root {
      --keyboard-offset: 0px;
    }

    .page-shell {
      min-height: calc(100vh - 120px);
      padding: 12px 0 calc(116px + var(--keyboard-offset));
    }
    @media (max-width: 991px) {
      .page-shell {
        padding-bottom: calc(132px + var(--keyboard-offset));
      }
    }

    .card-soft {
      border: 1px solid #e6eef5;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.07);
      background: #fff;
    }

    .mobile-bottom-nav {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: var(--bottom-nav-bg);
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 22px;
      padding: 6px 8px;
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.14);
      backdrop-filter: blur(12px);
      z-index: 900;
    }

    .mobile-bottom-nav .bottom-item {
      text-decoration: none;
      color: #7b8a9c;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      flex: 1;
    }

    .mobile-bottom-nav .bottom-item .bottom-icon {
      font-size: 18px;
    }

    .mobile-bottom-nav .bottom-item.active {
      color: #0d6efd;
      font-weight: 600;
    }

    @media (min-width: 992px) {
      .mobile-bottom-nav {
        display: none;
      }
    }

    .toast-container {
      z-index: 1100;
    }

    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(2px);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: 0.2s ease;
      z-index: 1050;
      display: none;
    }
    .menu-overlay.show {
      opacity: 1;
      visibility: visible;
      display: block;
      pointer-events: auto;
    }
    .mobile-menu {
      position: fixed;
      top: 12px;
      left: auto;
      right: -320px;
      width: 280px;
      height: calc(100vh - 24px);
      background: linear-gradient(160deg, var(--menu-bg-start) 0%, #f8fbff 48%, var(--menu-bg-end) 100%);
      box-shadow: -14px 0 28px rgba(15, 23, 42, 0.16);
      border-radius: 24px 0 0 24px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 62px 16px 20px;
      transition: 0.25s ease;
      z-index: 1060;
      pointer-events: none;
      overflow-y: auto;
    }
    .mobile-menu.open {
      left: auto;
      right: 12px;
      pointer-events: auto;
    }

    .menu-header {
      height: 0;
      margin: 0;
      padding: 0;
      border: none;
    }

    .menu-close {
      position: fixed;
      top: 12px;
      right: 16px;
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255, 255, 255, 0.65);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #526273;
      padding: 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, background 0.2s ease, color 0.2s ease;
    }
    .menu-close:hover {
      background: rgba(255, 255, 255, 0.9);
      color: #1f2d3d;
    }
    .mobile-menu.open .menu-close {
      opacity: 1;
      pointer-events: auto;
    }

    .mobile-menu .list-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .mobile-menu .list-group-item {
      display: block;
      width: 100%;
      border-radius: 14px;
      border: 1px solid transparent;
      background: var(--menu-item-bg);
      color: #1f2d3d;
      font-weight: 600;
      padding: 10px 12px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      text-align: left;
    }
    .mobile-menu .list-group-item-action:hover {
      background: var(--menu-item-hover);
      border-color: rgba(13, 110, 253, 0.15);
    }
    .mobile-menu .list-group-item-action:active {
      transform: translateY(1px);
    }
    .mobile-menu form {
      margin: 0;
    }

    .hover-shadow {
      transition: box-shadow 0.2s ease, transform 0.2s ease, background 0.2s;
    }
    .hover-shadow:hover {
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
      background: #f8fbff;
      transform: translateY(-1px);
    }

    .dosing-head,
    .dosing-cell {
      background: #eef5ff !important;
    }
    .dosing-group {
      background: #eef5ff !important;
    }

    .offline-toast {
      position: fixed;
      bottom: 90px;
      right: 16px;
      z-index: 1200;
      background: #0d6efd;
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(13, 110, 253, 0.25);
      display: none;
    }
    .plan-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .plan-badge--personal_free {
      background: #e6f8ef;
      color: #1f8f4a;
    }
    .plan-badge--company_trial {
      background: #e6f1fa;
      color: #0d6efd;
    }
    .plan-badge--company_paid {
      background: #f2f1ff;
      color: #4b4fe0;
    }
    .plan-badge--company_expired {
      background: #fdecec;
      color: #b42318;
    }
    [data-requires-access] {
      cursor: not-allowed;
    }

    .multi-select {
      position: relative;
      min-width: 220px;
    }
    .multi-select__trigger {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid #dbe5f5;
      border-radius: 12px;
      background: #f8fbff;
      color: #1f2d3d;
      text-align: left;
    }
    .multi-select__trigger:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.16);
    }
    .multi-select--open .multi-select__trigger {
      background: #f0f6ff;
      border-color: #cfe0ff;
    }
    .multi-select__value {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .multi-select__caret {
      color: #6c7a90;
      display: flex;
      align-items: center;
    }
    .multi-select__dropdown {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #e6eef5;
      border-radius: 12px;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
      padding: 8px;
      max-height: 260px;
      overflow-y: auto;
      display: none;
      z-index: 30;
    }
    .multi-select--drop-up .multi-select__dropdown {
      top: auto;
      bottom: calc(100% + 6px);
    }
    .multi-select--open .multi-select__dropdown {
      display: block;
    }
    .multi-select__option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
    }
    .multi-select__option input {
      width: 16px;
      height: 16px;
      margin: 0;
    }
    .multi-select__option:hover {
      background: #f0f6ff;
    }
    .multi-select__empty {
      padding: 6px 8px;
      color: #8a97a8;
      font-size: 0.85rem;
    }
    .multi-select__option--locked {
      opacity: 0.75;
      cursor: default;
    }
    .multi-select__option--locked input {
      pointer-events: none;
    }

    .task-form__row {
      margin-top: 2px;
    }
    .task-form__separator {
      color: #8a97a8;
      font-weight: 600;
    }
    .task-form__field {
      flex: 1 1 140px;
      min-width: 140px;
    }
    .task-form__field--date input,
    .task-form__field--time input {
      width: 100%;
    }

    .task-modal__content .modal-header {
      border-bottom: none;
      padding-bottom: 0;
    }
    .task-modal__content .modal-title:empty {
      display: none;
    }

    .task-history {
      border: 1px solid #e6eef5;
      border-radius: 12px;
      padding: 12px 14px;
      background: #fff;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
    }
    .task-history__summary {
      cursor: pointer;
      font-weight: 600;
      color: #1f2d3d;
      list-style: none;
    }
    .task-history__summary::-webkit-details-marker {
      display: none;
    }
    .task-history__summary::after {
      content: "▼";
      float: right;
      font-size: 0.75rem;
      color: #98a6b5;
      transition: transform 0.2s ease;
    }
    .task-history[open] .task-history__summary::after {
      transform: rotate(180deg);
    }
  </style>
  {% block extra_head %}{% endblock %}
</head>

<body>
  <!-- Yandex.Metrika counter (noscript) -->
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/106179770" style="position: absolute; left: -9999px" alt="" />
    </div>
  </noscript>
  <!-- /Yandex.Metrika counter (noscript) -->
  {% if user.is_authenticated %}
  <header class="app-header py-2" {% if hide_header %}style="display:none"{% endif %}>
    <div class="container">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
        <a href="{% if not is_personal_user %}{% url 'readings_all' %}{% else %}{{ personal_pool_url|default:'/pools' }}{% endif %}" class="d-flex align-items-center gap-3 text-decoration-none">
          <img src="{% static brand_logo %}" class="app-logo{% if brand_logo_wide %} app-logo--wide{% endif %}" alt="{{ brand_name }}">
          <div class="{% if brand_hide_text_on_mobile %}d-none d-md-block{% endif %}">
            <div class="fw-bold text-dark">{{ brand_name }}</div>
            <div class="text-muted small">&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1072; &#1086;&#1073;&#1089;&#1083;&#1091;&#1078;&#1080;&#1074;&#1072;&#1085;&#1080;&#1103; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;&#1086;&#1074;</div>
          </div>
        </a>

        <div class="d-flex align-items-center gap-3">
          <a class="header-icon d-lg-none position-relative" href="{% url 'notifications' %}" aria-label="&#1059;&#1074;&#1077;&#1076;&#1086;&#1084;&#1083;&#1077;&#1085;&#1080;&#1103;">
            <i class="bi bi-bell fs-5"></i>
            {% if notifications_unread_count %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ notifications_unread_count }}
              </span>
            {% endif %}
          </a>
          <button class="header-icon d-lg-none" type="button" onclick="openMenu()" aria-label="&#1054;&#1090;&#1082;&#1088;&#1099;&#1090;&#1100; &#1084;&#1077;&#1085;&#1102;" data-menu-button="true">
            <i class="bi bi-list fs-4"></i>
          </button>
          <nav class="d-none d-lg-flex align-items-center gap-3">
          {% if can_access_crm %}
            <a class="text-decoration-none {% if active_tab == 'crm' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="{% url 'crm_index' %}">CRM</a>
          {% endif %}
          {% if not is_personal_user %}
          <a class="text-decoration-none {% if active_tab == 'readings' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="/readings/all">&#1050;&#1072;&#1083;&#1077;&#1085;&#1076;&#1072;&#1088;&#1100;</a>
          {% endif %}
          <a class="text-decoration-none {% if active_tab == 'pools' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="{{ personal_pool_url|default:'/pools' }}">
            {% if is_personal_user %}
              &#1052;&#1086;&#1081; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;
            {% else %}
              &#1052;&#1086;&#1080; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;&#1099;
            {% endif %}
          </a>
          {% if is_org_staff %}
            <a class="text-decoration-none {% if active_tab == 'clients' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="{% url 'clients_list' %}">&#1050;&#1083;&#1080;&#1077;&#1085;&#1090;&#1099;</a>
          {% endif %}
          {% if user.is_authenticated %}
            {% with org_admins=user.organizationaccess_set.all %}
              {% if user.is_superuser or org_admins|length %}
                <a class="text-decoration-none {% if active_tab == 'users' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="{% url 'users' %}">&#1055;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1080;</a>
              {% endif %}
            {% endwith %}
          {% endif %}
          <a class="text-decoration-none {% if active_tab == 'profile' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="{% url 'profile' %}">&#1055;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;</a>
          <a class="text-decoration-none d-inline-flex align-items-center justify-content-center position-relative {% if active_tab == 'notifications' %}text-primary{% else %}text-muted{% endif %}" href="{% url 'notifications' %}" aria-label="&#1059;&#1074;&#1077;&#1076;&#1086;&#1084;&#1083;&#1077;&#1085;&#1080;&#1103;" title="&#1059;&#1074;&#1077;&#1076;&#1086;&#1084;&#1083;&#1077;&#1085;&#1080;&#1103;">
            <i class="bi bi-bell fs-5"></i>
            {% if notifications_unread_count %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ notifications_unread_count }}
              </span>
            {% endif %}
          </a>
          </nav>

          {% if plan_badge %}
            <div class="d-none d-lg-flex align-items-center">
              {% if plan_badge.type == 'company_expired' %}
                <a href="{{ payment_url|default:'/billing/' }}" class="plan-badge plan-badge--company_expired text-decoration-none">
                  Trial: 0 &#1076;&#1085;&#1077;&#1081;
                </a>
              {% else %}
                <span class="plan-badge plan-badge--{{ plan_badge.type }}">
                  {% if plan_badge.type == 'personal_free' %}
                    Free (1 &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;)
                  {% elif plan_badge.type == 'company_trial' %}
                    Trial: {{ plan_badge.days_left }} &#1076;&#1085;&#1077;&#1081;
                  {% elif plan_badge.type == 'company_paid' %}
                    Paid &#1076;&#1086; {{ plan_badge.paid_until|date:"d.m.Y" }}
                  {% endif %}
                </span>
              {% endif %}
            </div>
          {% endif %}

          {% if show_add_button and add_url %}
            {% if access_blocked %}
              <a href="{{ add_url }}" class="btn btn-primary btn-lg rounded-3 shadow-sm d-flex align-items-center justify-content-center opacity-50" data-requires-access="true" style="width: 46px; height: 46px;">
                <i class="bi bi-plus-lg"></i>
              </a>
            {% else %}
              <a href="{{ add_url }}" class="btn btn-primary btn-lg rounded-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 46px; height: 46px;">
                <i class="bi bi-plus-lg"></i>
              </a>
            {% endif %}
          {% endif %}

          {% if not user.is_authenticated %}
            <a class="btn btn-primary rounded-3 px-4" href="{% url 'login' %}">&#1042;&#1086;&#1081;&#1090;&#1080;</a>
          {% endif %}
        </div>
      </div>
    </div>
  </header>
  {% endif %}

  <main class="page-shell">
    <div class="container">
      {% if page_title %}
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
          <div>
            <h1 class="fw-bold h3 mb-1">{{ page_title }}</h1>
            {% if page_subtitle %}
              <div class="text-muted">{{ page_subtitle }}</div>
            {% endif %}
          </div>
          {% if page_action_label and page_action_url %}
            {% if access_blocked %}
              <a href="{{ page_action_url }}" class="btn btn-primary rounded-3 d-flex align-items-center gap-2 opacity-50" data-requires-access="true" aria-label="{{ page_action_label }}" title="{{ page_action_label }}">
                <i class="bi bi-plus-lg"></i><span class="d-none d-sm-inline">{{ page_action_label }}</span>
              </a>
            {% else %}
              <a href="{{ page_action_url }}" class="btn btn-primary rounded-3 d-flex align-items-center gap-2" aria-label="{{ page_action_label }}" title="{{ page_action_label }}">
                <i class="bi bi-plus-lg"></i><span class="d-none d-sm-inline">{{ page_action_label }}</span>
              </a>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- Mobile drawer -->
  {% if user.is_authenticated %}
  <div id="menu-overlay" class="menu-overlay" onclick="closeMenu()"></div>
  <div id="mobile-menu" class="mobile-menu">
      <div class="menu-header d-flex align-items-center justify-content-end">
          <button class="menu-close" type="button" onclick="closeMenu()" aria-label="&#1047;&#1072;&#1082;&#1088;&#1099;&#1090;&#1100; &#1084;&#1077;&#1085;&#1102;">
              <i class="bi bi-x-lg"></i>
          </button>
      </div>
      {% if plan_badge %}
      <div class="mb-3">
          {% if plan_badge.type == 'company_expired' %}
          <a href="{{ payment_url|default:'/billing/' }}" class="plan-badge plan-badge--company_expired text-decoration-none">
              Trial: 0 &#1076;&#1085;&#1077;&#1081;
          </a>
          {% else %}
          <span class="plan-badge plan-badge--{{ plan_badge.type }}">
              {% if plan_badge.type == 'personal_free' %}
              Free (1 &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;)
              {% elif plan_badge.type == 'company_trial' %}
              Trial: {{ plan_badge.days_left }} &#1076;&#1085;&#1077;&#1081;
              {% elif plan_badge.type == 'company_paid' %}
              Paid &#1076;&#1086; {{ plan_badge.paid_until|date:"d.m.Y" }}
              {% endif %}
          </span>
          {% endif %}
      </div>
      {% endif %}
      <div class="list-group list-group-flush">
          {% if can_access_crm %}
          <a href="{% url 'crm_index' %}" class="list-group-item list-group-item-action">CRM</a>
          {% endif %}
          {% if not is_personal_user %}
          <a href="/readings/all" class="list-group-item list-group-item-action">&#1050;&#1072;&#1083;&#1077;&#1085;&#1076;&#1072;&#1088;&#1100;</a>
          {% endif %}
          <a href="{{ personal_pool_url|default:'/pools' }}" class="list-group-item list-group-item-action">
            {% if is_personal_user %}
              &#1052;&#1086;&#1081; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;
            {% else %}
              &#1052;&#1086;&#1080; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;&#1099;
            {% endif %}
          </a>
          {% if is_org_staff %}
          <a href="{% url 'clients_list' %}" class="list-group-item list-group-item-action">&#1050;&#1083;&#1080;&#1077;&#1085;&#1090;&#1099;</a>
          {% endif %}
          {% if user.is_authenticated %}
            {% with org_admins=user.organizationaccess_set.all %}
              {% if user.is_superuser or org_admins|length %}
                <a href="{% url 'users' %}" class="list-group-item list-group-item-action">&#1055;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1080;</a>
              {% endif %}
            {% endwith %}
          {% endif %}
          <a href="{% url 'profile' %}" class="list-group-item list-group-item-action">&#1055;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;</a>
      </div>
  </div>
  {% endif %}

    {% if not hide_install_banner %}
    <div id="install-banner" class="position-fixed bottom-0 start-0 end-0 p-3" style="z-index:1080; display:none;">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
          <div>
            <div class="fw-semibold">&#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1077; {{ brand_name }}</div>
            <div id="install-banner-text" class="text-muted small">&#1044;&#1086;&#1073;&#1072;&#1074;&#1100;&#1090;&#1077; &#1087;&#1088;&#1080;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1075;&#1083;&#1072;&#1074;&#1085;&#1099;&#1081; &#1101;&#1082;&#1088;&#1072;&#1085; &#1076;&#1083;&#1103; &#1073;&#1099;&#1089;&#1090;&#1088;&#1086;&#1075;&#1086; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087;&#1072;.</div>
          </div>
          <div class="d-flex gap-2">
            <button id="install-dismiss" type="button" class="btn btn-outline-secondary btn-sm">&#1055;&#1086;&#1079;&#1078;&#1077;</button>
            <button id="install-btn" type="button" class="btn btn-primary btn-sm">&#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100;</button>
          </div>
        </div>
      </div>
    </div>
    <div id="ios-install-banner" class="position-fixed bottom-0 start-0 end-0 p-3" style="z-index:1080; display:none;">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex flex-column gap-2">
          <div class="fw-semibold">&#1044;&#1086;&#1073;&#1072;&#1074;&#1100;&#1090;&#1077; {{ brand_name }} &#1085;&#1072; &#1101;&#1082;&#1088;&#1072;&#1085; &#171;&#1044;&#1086;&#1084;&#1086;&#1081;&#187;</div>
          <div class="text-muted small">&#1053;&#1072;&#1078;&#1084;&#1080;&#1090;&#1077; &#171;&#1055;&#1086;&#1076;&#1077;&#1083;&#1080;&#1090;&#1100;&#1089;&#1103;&#187; &#1080; &#1074;&#1099;&#1073;&#1077;&#1088;&#1080;&#1090;&#1077; &#171;&#1053;&#1072; &#1101;&#1082;&#1088;&#1072;&#1085; &#1044;&#1086;&#1084;&#1086;&#1081;&#187;.</div>
          <div class="d-flex gap-2">
            <button id="ios-install-dismiss" type="button" class="btn btn-outline-secondary btn-sm">&#1055;&#1086;&#1085;&#1103;&#1090;&#1085;&#1086;</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
  {% if messages %}
    {% for message in messages %}
      <div class="toast align-items-center text-bg-light border-0 shadow-sm mb-2 show" role="alert">
        <div class="d-flex">
            <div class="toast-body">
              {% if message.tags %}
                <span class="badge bg-light text-dark border me-2 text-uppercase">{{ message.tags }}</span>
              {% endif %}
              {{ message }}
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <div id="offline-toast" class="offline-toast"></div>
  <div class="modal fade" id="accessBlockedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">&#1044;&#1086;&#1089;&#1090;&#1091;&#1087; &#1079;&#1072;&#1073;&#1083;&#1086;&#1082;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          &#1055;&#1088;&#1086;&#1073;&#1085;&#1099;&#1081; &#1087;&#1077;&#1088;&#1080;&#1086;&#1076; &#1080;&#1083;&#1080; &#1086;&#1087;&#1083;&#1072;&#1095;&#1077;&#1085;&#1085;&#1099;&#1081; &#1087;&#1077;&#1088;&#1080;&#1086;&#1076; &#1079;&#1072;&#1082;&#1086;&#1085;&#1095;&#1080;&#1083;&#1089;&#1103;. &#1044;&#1083;&#1103; &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103; &#1088;&#1072;&#1073;&#1086;&#1090;&#1099; &#1086;&#1087;&#1083;&#1072;&#1090;&#1080;&#1090;&#1077; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087;.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">&#1054;&#1090;&#1084;&#1077;&#1085;&#1072;</button>
          <a href="{{ payment_url|default:'/billing/' }}" class="btn btn-primary">&#1055;&#1077;&#1088;&#1077;&#1081;&#1090;&#1080; &#1082; &#1086;&#1087;&#1083;&#1072;&#1090;&#1077;</a>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="confirmActionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmActionTitle">&#1055;&#1086;&#1076;&#1090;&#1074;&#1077;&#1088;&#1076;&#1080;&#1090;&#1077; &#1076;&#1077;&#1081;&#1089;&#1090;&#1074;&#1080;&#1077;</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmActionBody">
          &#1055;&#1086;&#1076;&#1090;&#1074;&#1077;&#1088;&#1076;&#1080;&#1090;&#1077; &#1076;&#1077;&#1081;&#1089;&#1090;&#1074;&#1080;&#1077;.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">&#1054;&#1090;&#1084;&#1077;&#1085;&#1072;</button>
          <button type="button" class="btn btn-primary js-confirm-submit">&#1055;&#1086;&#1076;&#1090;&#1074;&#1077;&#1088;&#1076;&#1080;&#1090;&#1100;</button>
        </div>
      </div>
    </div>
  </div>

  <div id="pwa-debug" class="position-fixed bottom-0 end-0 p-3" style="z-index:1090; display:none;">
    <div class="card shadow-sm border-0">
      <div class="card-body small">
        <div class="fw-semibold mb-1">PWA debug</div>
        <div><span class="text-muted">manifest:</span> <span id="pwa-manifest">...</span></div>
        <div><span class="text-muted">icons:</span> <span id="pwa-icons">...</span></div>
        <div><span class="text-muted">sw file:</span> <span id="pwa-sw-file">...</span></div>
        <div><span class="text-muted">service worker:</span> <span id="pwa-sw">...</span></div>
        <div><span class="text-muted">scope:</span> <span id="pwa-scope">...</span></div>
        <div><span class="text-muted">controller:</span> <span id="pwa-controller">...</span></div>
        <div><span class="text-muted">install prompt:</span> <span id="pwa-prompt">...</span></div>
        <div><span class="text-muted">display mode:</span> <span id="pwa-display">...</span></div>
      </div>
    </div>
  </div>

  {% if not hide_bottom_nav %}
  {% if user.is_authenticated %}
      <div class="mobile-bottom-nav">
      <a href="{{ personal_pool_url|default:'/pools' }}" class="bottom-item {% if active_tab == 'pools' %}active{% endif %}">
        <i class="bi bi-stack bottom-icon"></i>
        <span>
          {% if is_personal_user %}
            &#1052;&#1086;&#1081; &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;
          {% else %}
            &#1052;&#1086;&#1080; &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;&#1099;
          {% endif %}
        </span>
      </a>
      {% if not is_personal_user %}
      <a href="/readings/all" class="bottom-item {% if active_tab == 'readings' %}active{% endif %}">
        <i class="bi bi-calendar2-week bottom-icon"></i>
        <span>&#1050;&#1072;&#1083;&#1077;&#1085;&#1076;&#1072;&#1088;&#1100;</span>
      </a>
      {% endif %}
      <a href="{% url 'profile' %}" class="bottom-item {% if active_tab == 'profile' %}active{% endif %}">
        <i class="bi bi-person-circle bottom-icon"></i>
        <span>&#1055;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;</span>
      </a>
  </div>
  {% endif %}
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".toast").forEach(function (el) {
        const toast = new bootstrap.Toast(el, { delay: 4000 });
        toast.show();
      });

      // сбрасываем состояние мобильного меню при загрузке
      closeMenu();
      positionMenuClose();
      window.addEventListener("resize", positionMenuClose);
    });

    function positionMenuClose() {
      const closeBtn = document.querySelector(".menu-close");
      const menuBtn = document.querySelector("[data-menu-button]");
      if (!closeBtn || !menuBtn) return;
      const rect = menuBtn.getBoundingClientRect();
      closeBtn.style.top = `${Math.round(rect.top)}px`;
      closeBtn.style.left = `${Math.round(rect.left)}px`;
      closeBtn.style.right = "auto";
    }

    function openMenu() {
      positionMenuClose();
      document.getElementById("mobile-menu").classList.add("open");
      document.getElementById("menu-overlay").classList.add("show");
    }
    function closeMenu() {
      document.getElementById("mobile-menu").classList.remove("open");
      document.getElementById("menu-overlay").classList.remove("show");
    }

    // simple offline form queue
    const offlineToast = document.getElementById("offline-toast");
    function showOfflineToast(text) {
      if (!offlineToast) return;
      offlineToast.textContent = text;
      offlineToast.style.display = "block";
      setTimeout(() => (offlineToast.style.display = "none"), 4000);
    }

    function loadQueue() {
      try {
        return JSON.parse(localStorage.getItem("offlineQueue") || "[]");
      } catch (e) {
        return [];
      }
    }
    function saveQueue(queue) {
      localStorage.setItem("offlineQueue", JSON.stringify(queue));
    }

    function updateOfflineStatus() {
      const statusEl = document.getElementById("offline-status");
      if (!statusEl) return;
      const queued = loadQueue().length;
      if (!navigator.onLine) {
        statusEl.textContent = "\u041e\u0444\u043b\u0430\u0439\u043d: \u0434\u0430\u043d\u043d\u044b\u0435 \u0431\u0443\u0434\u0443\u0442 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u044b \u0438 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043f\u0440\u0438 \u043f\u043e\u044f\u0432\u043b\u0435\u043d\u0438\u0438 \u0441\u0435\u0442\u0438.";
        statusEl.classList.remove("d-none");
        return;
      }
      if (queued) {
        statusEl.textContent = "\u0415\u0441\u0442\u044c \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435. \u041e\u043d\u0438 \u043e\u0442\u043f\u0440\u0430\u0432\u044f\u0442\u0441\u044f \u043f\u0440\u0438 \u043f\u043e\u044f\u0432\u043b\u0435\u043d\u0438\u0438 \u0441\u0435\u0442\u0438.";
        statusEl.classList.remove("d-none");
        return;
      }
      statusEl.classList.add("d-none");
    }

    async function processQueue() {
      const queue = loadQueue();
      if (!queue.length || !navigator.onLine) {
        updateOfflineStatus();
        return;
      }
      let sentCount = 0;
      while (queue.length) {
        const item = queue[0];
        try {
          const resp = await fetch(item.action, {
            method: item.method,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
              "X-CSRFToken": item.csrf || "",
            },
            body: item.body,
            credentials: "include",
          });
          if (!resp.ok) throw new Error("Network error");
          queue.shift();
          saveQueue(queue);
          sentCount += 1;
        } catch (e) {
          break;
        }
      }
      if (sentCount > 0 && queue.length === 0) {
        showOfflineToast("\u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b.");
      }
      updateOfflineStatus();
    }

    window.addEventListener("online", processQueue);
    window.addEventListener("offline", updateOfflineStatus);

    document.addEventListener("submit", function (e) {
      const form = e.target;
      if (!form.classList.contains("offline-queue-form")) return;
      if (navigator.onLine) return;

      e.preventDefault();
      const fd = new FormData(form);
      const params = new URLSearchParams(fd);
      const csrf = fd.get("csrfmiddlewaretoken") || "";
      const queue = loadQueue();
      queue.push({
        action: form.action,
        method: form.method || "POST",
        body: params.toString(),
        csrf,
      });
      saveQueue(queue);
      showOfflineToast("\u041d\u0435\u0442 \u0441\u0435\u0442\u0438. \u0414\u0430\u043d\u043d\u044b\u0435 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u044b \u0438 \u0431\u0443\u0434\u0443\u0442 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043f\u0440\u0438 \u0432\u043e\u0441\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0438 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f.");
      updateOfflineStatus();
    });

    if (navigator.onLine) {
      processQueue();
    }
    updateOfflineStatus();

    // PWA: регистрация service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/sw.js", { scope: "/" })
          .then(() => {
            const reloadKey = "swReloaded";
            navigator.serviceWorker.ready.then(() => {
              if (!navigator.serviceWorker.controller && !sessionStorage.getItem(reloadKey)) {
                sessionStorage.setItem(reloadKey, "1");
                window.location.reload();
              }
            });
          })
          .catch((err) => {
            console.error("SW registration failed", err);
            const swEl = document.getElementById("pwa-sw");
            const controllerEl = document.getElementById("pwa-controller");
            if (swEl) swEl.textContent = "error";
            if (controllerEl) controllerEl.textContent = "not controlled";
          });
      });
    }

    const pushEnabled = {{ push_enabled|yesno:"true,false" }};
    const pushPublicKey = "{{ push_public_key|default:'' }}";

    function getCsrfToken() {
      const name = "csrftoken=";
      const decodedCookie = decodeURIComponent(document.cookie || "");
      const parts = decodedCookie.split("; ");
      for (const part of parts) {
        if (part.startsWith(name)) return part.substring(name.length);
      }
      return "";
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function syncPushSubscription() {
      if (!pushEnabled || !pushPublicKey) return;
      if (!("serviceWorker" in navigator) || !("PushManager" in window) || !("Notification" in window)) return;
      try {
        const reg = await navigator.serviceWorker.ready;
        let sub = await reg.pushManager.getSubscription();
        if (!sub) {
          const permission = await Notification.requestPermission();
          if (permission !== "granted") return;
          sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(pushPublicKey),
          });
        }
        await fetch("/api/push/subscribe/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(),
          },
          body: JSON.stringify(sub),
          credentials: "same-origin",
        });
      } catch (err) {
        console.warn("Push subscription failed", err);
      }
    }

    window.addEventListener("load", () => {
      syncPushSubscription();
    });

    // PWA: собственный промпт установки
    let deferredPrompt = null;
    const installBanner = document.getElementById("install-banner");
    const installBtn = document.getElementById("install-btn");
    const installDismiss = document.getElementById("install-dismiss");
    const installText = document.getElementById("install-banner-text");
    let installPromptFired = false;
    function getStoredInstalled() {
      try {
        return localStorage.getItem("pwaInstalled") === "1";
      } catch (e) {
        return false;
      }
    }
    function setStoredInstalled() {
      try {
        localStorage.setItem("pwaInstalled", "1");
      } catch (e) {}
    }
    async function isAppInstalled() {
      if (isStandalone()) {
        setStoredInstalled();
        return true;
      }
      if (getStoredInstalled()) {
        return true;
      }
      if ("getInstalledRelatedApps" in navigator) {
        try {
          const related = await navigator.getInstalledRelatedApps();
          if (Array.isArray(related) && related.length) {
            setStoredInstalled();
            return true;
          }
        } catch (e) {}
      }
      return false;
    }

    function setInstallBannerPrompt() {
      if (installText) {
        installText.textContent = "\u0414\u043e\u0431\u0430\u0432\u044c\u0442\u0435 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u043d\u0430 \u0433\u043b\u0430\u0432\u043d\u044b\u0439 \u044d\u043a\u0440\u0430\u043d \u0434\u043b\u044f \u0431\u044b\u0441\u0442\u0440\u043e\u0433\u043e \u0434\u043e\u0441\u0442\u0443\u043f\u0430.";
      }
      if (installBtn) installBtn.style.display = "inline-block";
    }
    function setInstallBannerManual() {
      if (installText) {
        installText.textContent = "\u041e\u0442\u043a\u0440\u043e\u0439\u0442\u0435 \u043c\u0435\u043d\u044e \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430 \u0438 \u0432\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u201c\u0423\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435\u201d.";
      }
      if (installBtn) installBtn.style.display = "none";
    }

    function showInstallBanner() {
      if (!installBanner) return;
      installBanner.style.display = "block";
    }
    function hideInstallBanner() {
      if (!installBanner) return;
      installBanner.style.display = "none";
    }

    window.addEventListener("beforeinstallprompt", async (e) => {
      e.preventDefault();
      if (await isAppInstalled()) return;
      deferredPrompt = e;
      installPromptFired = true;
      setInstallBannerPrompt();
      showInstallBanner();
      const swEl = document.getElementById("pwa-sw");
      const scopeEl = document.getElementById("pwa-scope");
      const controllerEl = document.getElementById("pwa-controller");
      const promptEl = document.getElementById("pwa-prompt");
      if (promptEl) promptEl.textContent = "fired";
      setTimeout(() => {
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.getRegistration().then((reg) => {
            if (swEl) swEl.textContent = reg ? "registered" : "not registered";
            if (scopeEl) scopeEl.textContent = reg ? reg.scope : "-";
          });
          if (controllerEl) controllerEl.textContent = navigator.serviceWorker.controller ? "controlled" : "not controlled";
        }
      }, 2000);
      setTimeout(() => {
        if (controllerEl) controllerEl.textContent = navigator.serviceWorker.controller ? "controlled" : "not controlled";
      }, 1500);
    });

    installBtn?.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      hideInstallBanner();
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    });

    installDismiss?.addEventListener("click", () => {
      hideInstallBanner();
      deferredPrompt = null;
    });


    setTimeout(async () => {
      if (installPromptFired) return;
      if (await isAppInstalled()) return;
      if (isIosDevice()) return;
      setInstallBannerManual();
      showInstallBanner();
    }, 2000);
    window.addEventListener("appinstalled", () => {
      setStoredInstalled();
      hideInstallBanner();
      deferredPrompt = null;
      const promptEl = document.getElementById("pwa-prompt");
      if (promptEl) promptEl.textContent = "installed";
    });

    // iOS install hint (custom banner)
    const iosBanner = document.getElementById("ios-install-banner");
    const iosDismiss = document.getElementById("ios-install-dismiss");
    function isIosDevice() {
      const ua = navigator.userAgent || "";
      const iOS = /iphone|ipad|ipod/i.test(ua);
      const iPadOS = navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1;
      return iOS || iPadOS;
    }
    function isStandalone() {
      return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
    }
    function showIosBanner() {
      if (!iosBanner) return;
      iosBanner.style.display = "block";
    }
    function hideIosBanner() {
      if (!iosBanner) return;
      iosBanner.style.display = "none";
    }
    function iosDismissed() {
      try {
        return sessionStorage.getItem("iosInstallDismissed") === "1";
      } catch (e) {
        return false;
      }
    }
    function setIosDismissed() {
      try {
        sessionStorage.setItem("iosInstallDismissed", "1");
      } catch (e) {}
    }
    if (isIosDevice() && !isStandalone() && !getStoredInstalled() && !iosDismissed()) {
      showIosBanner();
    }
    iosDismiss?.addEventListener("click", () => {
      hideIosBanner();
      setIosDismissed();
    });

    // PWA debug info (show with ?pwa_debug=1)
    const debugPanel = document.getElementById("pwa-debug");
    const params = new URLSearchParams(window.location.search);
    if (debugPanel && params.get("pwa_debug") === "1") {
      debugPanel.style.display = "block";
      const manifestEl = document.getElementById("pwa-manifest");
      const iconsEl = document.getElementById("pwa-icons");
      const scopeEl = document.getElementById("pwa-scope");
      const swFileEl = document.getElementById("pwa-sw-file");
      const swEl = document.getElementById("pwa-sw");
      const controllerEl = document.getElementById("pwa-controller");
      const promptEl = document.getElementById("pwa-prompt");
      const displayEl = document.getElementById("pwa-display");

      fetch("/manifest.webmanifest", { cache: "no-store" })
        .then(async (resp) => {
          if (!resp.ok) {
            if (manifestEl) manifestEl.textContent = `fail ${resp.status}`;
            return null;
          }
          if (manifestEl) manifestEl.textContent = "ok";
          try {
            return await resp.json();
          } catch (e) {
            return null;
          }
        })
        .then((data) => {
          if (!iconsEl) return;
          if (!data || !Array.isArray(data.icons) || data.icons.length === 0) {
            iconsEl.textContent = "none";
            return;
          }
          const iconUrls = data.icons.map((icon) => icon.src).filter(Boolean);
          Promise.all(
            iconUrls.map((url) =>
              fetch(url, { cache: "no-store" })
                .then((r) => `${url}: ${r.ok ? "ok" : "fail " + r.status}`)
                .catch(() => `${url}: error`)
            )
          ).then((results) => {
            iconsEl.textContent = results.join(" | ");
          });
        })
        .catch(() => {
          if (manifestEl) manifestEl.textContent = "error";
          if (iconsEl) iconsEl.textContent = "error";
        });

      fetch("/sw.js", { cache: "no-store" })
        .then((resp) => {
          const ct = resp.headers.get("content-type") || "";
          if (swFileEl) swFileEl.textContent = resp.ok ? `ok (${ct})` : `fail ${resp.status}`;
        })
        .catch(() => {
          if (swFileEl) swFileEl.textContent = "error";
        });

      const updateSwDebug = () => {
        if (!("serviceWorker" in navigator)) {
          if (swEl) swEl.textContent = "unsupported";
          if (scopeEl) scopeEl.textContent = "-";
          if (controllerEl) controllerEl.textContent = "unsupported";
          return;
        }
        navigator.serviceWorker.getRegistration().then((reg) => {
          if (swEl) swEl.textContent = reg ? "registered" : "not registered";
          if (scopeEl) scopeEl.textContent = reg ? reg.scope : "-";
          if (controllerEl) {
            controllerEl.textContent = navigator.serviceWorker.controller ? "controlled" : "not controlled";
          }
        });
      };
      updateSwDebug();
      setTimeout(updateSwDebug, 2000);

      if (promptEl) promptEl.textContent = installPromptFired ? "fired" : "not fired";

      const isStandaloneMode =
        window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
      if (displayEl) displayEl.textContent = isStandaloneMode ? "standalone" : "browser";
    }
  </script>
  <script>
    function formatPhoneMask(value) {
      let digits = value.replace(/\D/g, "");
      if (digits.startsWith("8")) digits = digits.slice(1);
      if (digits.startsWith("7")) digits = digits.slice(1);
      digits = digits.slice(0, 10);
      let res = "+7";
      if (digits.length > 0) res += " " + digits.substring(0, Math.min(3, digits.length));
      if (digits.length > 3) res += " " + digits.substring(3, Math.min(6, digits.length));
      if (digits.length > 6) res += " " + digits.substring(6, Math.min(10, digits.length));
      return res.trimEnd();
    }

    function applyPhoneMasks(root) {
      const scope = root || document;
      const selector = ".phone-mask, input[type='tel'], input[name*='phone'], input[name*='Phone']";
      scope.querySelectorAll(selector).forEach((inp) => {
        if (inp.dataset.phoneMask === "1") return;
        inp.dataset.phoneMask = "1";
        inp.classList.add("phone-mask");
        inp.value = formatPhoneMask(inp.value || "+7");
        inp.addEventListener("input", () => {
          inp.value = formatPhoneMask(inp.value);
          inp.setSelectionRange(inp.value.length, inp.value.length);
        });
        inp.addEventListener("focus", () => {
          if (!inp.value.trim()) inp.value = "+7 ";
        });
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      applyPhoneMasks();
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const accessBlocked = {{ access_blocked|default:False|yesno:"true,false" }};
      if (!accessBlocked) return;
      const modalEl = document.getElementById("accessBlockedModal");
      if (!modalEl) return;
      const modal = new bootstrap.Modal(modalEl);
      document.querySelectorAll("[data-requires-access]").forEach((el) => {
        el.addEventListener("click", (event) => {
          event.preventDefault();
          modal.show();
        });
      });
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const modalEl = document.getElementById("confirmActionModal");
      if (!modalEl) return;
      const modal = new bootstrap.Modal(modalEl);
      const titleEl = modalEl.querySelector("#confirmActionTitle");
      const bodyEl = modalEl.querySelector("#confirmActionBody");
      const submitBtn = modalEl.querySelector(".js-confirm-submit");
      let pendingForm = null;

      const setVariant = (variant) => {
        const base = "btn js-confirm-submit";
        submitBtn.className = `${base} ${variant ? "btn-" + variant : "btn-primary"}`;
      };

      modalEl.addEventListener("hidden.bs.modal", () => {
        pendingForm = null;
      });

      submitBtn.addEventListener("click", () => {
        if (!pendingForm) return;
        pendingForm.submit();
      });

      document.querySelectorAll(".js-confirm-action").forEach((btn) => {
        btn.addEventListener("click", (event) => {
          if (btn.hasAttribute("data-requires-access")) return;
          event.preventDefault();
          pendingForm = btn.closest("form");
          if (!pendingForm) return;
          titleEl.textContent = btn.dataset.confirmTitle || "\u041f\u043e\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u0435 \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435";
          bodyEl.textContent = btn.dataset.confirmBody || "\u041f\u043e\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u0435 \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435.";
          submitBtn.textContent = btn.dataset.confirmConfirm || "\u041f\u043e\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044c";
          setVariant(btn.dataset.confirmVariant || "");
          modal.show();
        });
      });
    });
  </script>
  <script>
    (function () {
      const isFormControl = (el) => {
        if (!el) return false;
        const tag = el.tagName;
        if (tag === "TEXTAREA" || tag === "SELECT") return true;
        if (tag !== "INPUT") return false;
        const type = (el.getAttribute("type") || "text").toLowerCase();
        return !["checkbox", "radio", "range", "file", "color"].includes(type);
      };

      const updateKeyboardOffset = () => {
        if (!window.visualViewport) return;
        const vv = window.visualViewport;
        const keyboard = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
        document.documentElement.style.setProperty("--keyboard-offset", `${keyboard}px`);
      };

      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", updateKeyboardOffset);
        window.visualViewport.addEventListener("scroll", updateKeyboardOffset);
        updateKeyboardOffset();
      }

      document.addEventListener("focusin", (event) => {
        if (!isFormControl(event.target)) return;
        setTimeout(() => {
          try {
            event.target.scrollIntoView({ block: "center", behavior: "smooth" });
          } catch (err) {
            event.target.scrollIntoView(true);
          }
        }, 250);
      });
    })();
  </script>
  <script>
    (function () {
      const getOptionLabel = (checkbox) => {
        const label = checkbox.closest(".multi-select__option");
        if (!label) return checkbox.value;
        return label.textContent.replace(/\s+/g, " ").trim();
      };

      const updateLabel = (root) => {
        const valueEl = root.querySelector(".multi-select__value");
        if (!valueEl) return;
        const placeholder = root.dataset.placeholder || "\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435";
        const checked = Array.from(root.querySelectorAll("input[type='checkbox']:checked"));
        if (!checked.length) {
          valueEl.textContent = placeholder;
          return;
        }
        const labels = checked.map(getOptionLabel);
        valueEl.textContent = labels.length <= 2 ? labels.join(", ") : `\u0412\u044b\u0431\u0440\u0430\u043d\u043e: ${labels.length}`;
      };

      const setDropdownPosition = (root) => {
        const dropdown = root.querySelector("[data-multi-select-list]");
        if (!dropdown) return;
        const rect = root.getBoundingClientRect();
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const spaceBelow = viewportHeight - rect.bottom;
        const spaceAbove = rect.top;
        const computed = window.getComputedStyle(dropdown);
        const maxHeight = parseInt(computed.maxHeight, 10) || 260;
        const needed = Math.min(dropdown.scrollHeight || maxHeight, maxHeight);
        const useDropUp = spaceBelow < needed && spaceAbove > spaceBelow;
        root.classList.toggle("multi-select--drop-up", useDropUp);
        const available = (useDropUp ? spaceAbove : spaceBelow) - 12;
        if (available > 120) {
          dropdown.style.maxHeight = `${Math.min(maxHeight, available)}px`;
        } else {
          dropdown.style.maxHeight = `${maxHeight}px`;
        }
      };

      const initMultiSelect = (root) => {
        if (!root || root.dataset.multiSelectReady === "1") return;
        const trigger = root.querySelector("[data-multi-select-trigger]");
        const list = root.querySelector("[data-multi-select-list]");
        if (!trigger || !list) return;
        root.dataset.multiSelectReady = "1";

        trigger.addEventListener("click", (event) => {
          event.preventDefault();
          const willOpen = !root.classList.contains("multi-select--open");
          root.classList.toggle("multi-select--open", willOpen);
          if (willOpen) {
            setDropdownPosition(root);
          }
        });

        root.addEventListener("change", (event) => {
          if (!event.target.matches("input[type='checkbox']")) return;
          updateLabel(root);
        });

        document.addEventListener("click", (event) => {
          if (root.contains(event.target)) return;
          root.classList.remove("multi-select--open");
          root.classList.remove("multi-select--drop-up");
        });

        updateLabel(root);
      };

      const initAllMultiSelects = (scope) => {
        const root = scope || document;
        root.querySelectorAll("[data-multi-select]").forEach(initMultiSelect);
      };

      document.addEventListener("DOMContentLoaded", () => initAllMultiSelects());
      window.initMultiSelect = initMultiSelect;
      window.initAllMultiSelects = initAllMultiSelects;
    })();
  </script>
  <script>
    (function () {
      const initTaskForms = (scope) => {
        const root = scope || document;
        root.querySelectorAll("[data-task-form]").forEach((form) => {
          if (form.dataset.taskFormReady === "1") return;
          form.dataset.taskFormReady = "1";

          const timeToggle = form.querySelector("[data-task-time-toggle]");
          const timeFields = form.querySelector("[data-task-time-fields]");
          const timeInputs = timeFields ? timeFields.querySelectorAll("input[type='time']") : [];

          const syncTimeFields = (clearValues) => {
            if (!timeFields || !timeToggle) return;
            const show = timeToggle.checked;
            timeFields.classList.toggle("d-none", !show);
            timeInputs.forEach((input) => {
              input.disabled = !show;
              if (!show && clearValues) {
                input.value = "";
              }
            });
          };

          if (timeToggle) {
            syncTimeFields(false);
            timeToggle.addEventListener("change", () => syncTimeFields(true));
          }

          form.querySelectorAll("input[data-locked='1']").forEach((input) => {
            input.checked = true;
            input.addEventListener("click", (event) => {
              event.preventDefault();
            });
          });

          if (window.initAllMultiSelects) {
            window.initAllMultiSelects(form);
          }
        });
      };

      document.addEventListener("DOMContentLoaded", () => initTaskForms());
      window.initTaskForms = initTaskForms;
    })();
  </script>
</body>
</html>
