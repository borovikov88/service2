{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Pool Service{% endblock %}</title>
  <meta name="theme-color" content="#0d6efd" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <link rel="icon" type="image/x-icon" href="{% static 'assets/images/favicon.ico' %}" />
  <link rel="manifest" href="{% static 'manifest.webmanifest' %}">
  <link rel="apple-touch-icon" href="{% static 'pool_service/img/logo.png' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="{% static 'assets/css/style.css' %}" rel="stylesheet" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    :root {
      --app-bg-start: #f4f9fd;
      --app-bg-end: #e6f1fa;
    }

    body {
      background: linear-gradient(180deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%);
      min-height: 100vh;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      color: #1f2d3d;
      margin: 0;
    }

    .app-header {
      background: #fff;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .app-logo {
      width: 44px;
      height: 44px;
    }

    .page-shell {
      min-height: calc(100vh - 120px);
      padding: 16px 0 104px;
    }

    .card-soft {
      border: 1px solid #e6eef5;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.07);
      background: #fff;
    }

    .mobile-bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #fff;
      border-top: 1px solid #e6eef5;
      padding: 10px 6px 12px;
      z-index: 900;
    }

    .mobile-bottom-nav .bottom-item {
      text-decoration: none;
      color: #7b8a9c;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      flex: 1;
    }

    .mobile-bottom-nav .bottom-item .bottom-icon {
      font-size: 18px;
    }

    .mobile-bottom-nav .bottom-item.active {
      color: #0d6efd;
      font-weight: 600;
    }

    @media (min-width: 992px) {
      .mobile-bottom-nav {
        display: none;
      }
    }

    .toast-container {
      z-index: 1100;
    }

    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: 0.2s ease;
      z-index: 1050;
      display: none;
    }
    .menu-overlay.show {
      opacity: 1;
      visibility: visible;
      display: block;
      pointer-events: auto;
    }
    .mobile-menu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 260px;
      height: 100vh;
      background: #fff;
      box-shadow: 6px 0 24px rgba(15, 23, 42, 0.08);
      padding: 16px;
      transition: 0.25s ease;
      z-index: 1060;
      pointer-events: none;
    }
    .mobile-menu.open {
      left: 0;
      pointer-events: auto;
    }

    .hover-shadow {
      transition: box-shadow 0.2s ease, transform 0.2s ease, background 0.2s;
    }
    .hover-shadow:hover {
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
      background: #f8fbff;
      transform: translateY(-1px);
    }

    .dosing-head,
    .dosing-cell {
      background: #eef5ff !important;
    }
    .dosing-group {
      background: #eef5ff !important;
    }

    .offline-toast {
      position: fixed;
      bottom: 90px;
      right: 16px;
      z-index: 1200;
      background: #0d6efd;
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(13, 110, 253, 0.25);
      display: none;
    }
  </style>
</head>

<body>
  <header class="app-header py-3" {% if hide_header %}style="display:none"{% endif %}>
    <div class="container">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-light d-lg-none border-0 shadow-sm" style="width:44px;height:44px;" onclick="openMenu()" aria-label="Меню">
            <i class="bi bi-list fs-4"></i>
          </button>
          <img src="{% static 'pool_service/img/logo.png' %}" class="app-logo" alt="Pool Service">
          <div>
            <div class="fw-bold text-dark">Pool Service</div>
            <div class="text-muted small">Система обслуживания бассейнов</div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-3">
          <nav class="d-none d-lg-flex align-items-center gap-3">
          <a class="text-decoration-none {% if active_tab == 'home' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="/">Главная</a>
          <a class="text-decoration-none {% if active_tab == 'readings' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="/readings/all">Показания</a>
          <a class="text-decoration-none {% if active_tab == 'pools' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="/pools">Мои бассейны</a>
          <a class="text-decoration-none {% if active_tab == 'profile' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="{% url 'profile' %}">Профиль</a>
          {% if user.is_authenticated %}
            {% with org_admins=user.organizationaccess_set.all %}
              {% if user.is_superuser or org_admins|length %}
                <a class="text-decoration-none {% if active_tab == 'users' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="{% url 'users' %}">Пользователи</a>
              {% endif %}
            {% endwith %}
          {% endif %}
          </nav>

          {% if show_add_button and add_url %}
            <a href="{{ add_url }}" class="btn btn-primary btn-lg rounded-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 46px; height: 46px;">
              <i class="bi bi-plus-lg"></i>
            </a>
          {% endif %}

          {% if not user.is_authenticated %}
            <a class="btn btn-primary rounded-3 px-4" href="{% url 'login' %}">Войти</a>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

  <main class="page-shell">
    <div class="container">
      {% if page_title %}
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
          <div>
            <h1 class="fw-bold h3 mb-1">{{ page_title }}</h1>
            {% if page_subtitle %}
              <div class="text-muted">{{ page_subtitle }}</div>
            {% endif %}
          </div>
          {% if page_action_label and page_action_url %}
            <a href="{{ page_action_url }}" class="btn btn-primary rounded-3 d-flex align-items-center gap-2" aria-label="{{ page_action_label }}" title="{{ page_action_label }}">
              <i class="bi bi-plus-lg"></i><span class="d-none d-sm-inline">{{ page_action_label }}</span>
            </a>
          {% endif %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- Mobile drawer -->
  <div id="menu-overlay" class="menu-overlay" onclick="closeMenu()"></div>
  <div id="mobile-menu" class="mobile-menu">
      <div class="menu-header d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center gap-2">
              <img src="{% static 'pool_service/img/logo.png' %}" class="app-logo" alt="Pool Service" style="width:38px;height:38px;">
              <div>
                  <div class="fw-bold text-dark">Pool Service</div>
                  <div class="text-muted small">Меню</div>
              </div>
          </div>
          <button class="btn btn-light border-0" onclick="closeMenu()" aria-label="Закрыть">
              <i class="bi bi-x-lg"></i>
          </button>
      </div>
      <div class="list-group list-group-flush">
          <a href="/" class="list-group-item list-group-item-action">Главная</a>
          <a href="{% url 'profile' %}" class="list-group-item list-group-item-action">Личный кабинет</a>
          <a href="/pools" class="list-group-item list-group-item-action">Мои бассейны</a>
          <a href="/readings/all" class="list-group-item list-group-item-action">История показаний</a>
          {% if user.is_authenticated %}
            {% with org_admins=user.organizationaccess_set.all %}
              {% if user.is_superuser or org_admins|length %}
                <a href="{% url 'users' %}" class="list-group-item list-group-item-action">Пользователи</a>
              {% endif %}
            {% endwith %}
          {% endif %}
          {% if user.is_authenticated %}
          <form method="post" action="{% url 'logout' %}" class="list-group-item list-group-item-action p-0 border-0">
              {% csrf_token %}
              <button class="btn w-100 text-start">Выйти</button>
          </form>
          {% endif %}
      </div>
  </div>

    <div id="install-banner" class="position-fixed bottom-0 start-0 end-0 p-3" style="z-index:1080; display:none;">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
          <div>
            <div class="fw-semibold">Установите Pool Service</div>
            <div class="text-muted small">Добавьте приложение на главный экран для быстрого доступа.</div>
          </div>
          <div class="d-flex gap-2">
            <button id="install-dismiss" type="button" class="btn btn-outline-secondary btn-sm">Позже</button>
            <button id="install-btn" type="button" class="btn btn-primary btn-sm">Установить</button>
          </div>
        </div>
      </div>
    </div>

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
  {% if messages %}
    {% for message in messages %}
      <div class="toast align-items-center text-bg-light border-0 shadow-sm mb-2 show" role="alert">
        <div class="d-flex">
            <div class="toast-body">
              {% if message.tags %}
                <span class="badge bg-light text-dark border me-2 text-uppercase">{{ message.tags }}</span>
              {% endif %}
              {{ message }}
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <div id="offline-toast" class="offline-toast"></div>

  {% if not hide_bottom_nav %}
    <div class="mobile-bottom-nav">
      <a href="/pools" class="bottom-item {% if active_tab == 'pools' %}active{% endif %}">
        <i class="bi bi-stack bottom-icon"></i>
        <span>Мои бассейны</span>
      </a>
      <a href="/readings/all" class="bottom-item {% if active_tab == 'readings' %}active{% endif %}">
        <i class="bi bi-journal-text bottom-icon"></i>
        <span>Показания</span>
      </a>
      <a href="{% url 'profile' %}" class="bottom-item {% if active_tab == 'profile' %}active{% endif %}">
        <i class="bi bi-person-circle bottom-icon"></i>
        <span>Профиль</span>
      </a>
    </div>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".toast").forEach(function (el) {
        const toast = new bootstrap.Toast(el, { delay: 4000 });
        toast.show();
      });

      // сбрасываем состояние мобильного меню при загрузке
      closeMenu();
    });

    function openMenu() {
      document.getElementById("mobile-menu").classList.add("open");
      document.getElementById("menu-overlay").classList.add("show");
    }
    function closeMenu() {
      document.getElementById("mobile-menu").classList.remove("open");
      document.getElementById("menu-overlay").classList.remove("show");
    }

    // simple offline form queue
    const offlineToast = document.getElementById("offline-toast");
    function showOfflineToast(text) {
      if (!offlineToast) return;
      offlineToast.textContent = text;
      offlineToast.style.display = "block";
      setTimeout(() => (offlineToast.style.display = "none"), 4000);
    }

    function loadQueue() {
      try {
        return JSON.parse(localStorage.getItem("offlineQueue") || "[]");
      } catch (e) {
        return [];
      }
    }
    function saveQueue(queue) {
      localStorage.setItem("offlineQueue", JSON.stringify(queue));
    }

    async function processQueue() {
      const queue = loadQueue();
      if (!queue.length || !navigator.onLine) return;
      while (queue.length) {
        const item = queue[0];
        try {
          const resp = await fetch(item.action, {
            method: item.method,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
              "X-CSRFToken": item.csrf || "",
            },
            body: item.body,
            credentials: "include",
          });
          if (!resp.ok) throw new Error("Network error");
          queue.shift();
          saveQueue(queue);
        } catch (e) {
          break;
        }
      }
      if (queue.length === 0) {
        showOfflineToast("Отложенные формы отправлены");
      }
    }

    window.addEventListener("online", processQueue);

    document.addEventListener("submit", function (e) {
      const form = e.target;
      if (!form.classList.contains("offline-queue-form")) return;
      if (navigator.onLine) return;

      e.preventDefault();
      const fd = new FormData(form);
      const params = new URLSearchParams(fd);
      const csrf = fd.get("csrfmiddlewaretoken") || "";
      const queue = loadQueue();
      queue.push({
        action: form.action,
        method: form.method || "POST",
        body: params.toString(),
        csrf,
      });
      saveQueue(queue);
      showOfflineToast("Нет сети. Данные сохранены и будут отправлены при подключении");
    });

    if (navigator.onLine) {
      processQueue();
    }

    // PWA: регистрация service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").catch((err) => console.error("SW registration failed", err));
      });
    }

    // PWA: собственный промпт установки
    let deferredPrompt = null;
    const installBanner = document.getElementById("install-banner");
    const installBtn = document.getElementById("install-btn");
    const installDismiss = document.getElementById("install-dismiss");

    function showInstallBanner() {
      if (!installBanner) return;
      installBanner.style.display = "block";
    }
    function hideInstallBanner() {
      if (!installBanner) return;
      installBanner.style.display = "none";
    }

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      if (window.matchMedia("(display-mode: standalone)").matches) return;
      deferredPrompt = e;
      showInstallBanner();
    });

    installBtn?.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      hideInstallBanner();
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    });

    installDismiss?.addEventListener("click", () => {
      hideInstallBanner();
      deferredPrompt = null;
    });

    window.addEventListener("appinstalled", () => {
      hideInstallBanner();
      deferredPrompt = null;
    });
  </script>
</body>
</html>
