{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}{{ brand_name }}{% endblock %}</title>
  <meta name="theme-color" content="#0d6efd" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <link rel="icon" type="image/png" href="{% static brand_favicon %}" />
  <link rel="manifest" href="{% url 'manifest' %}">
  <link rel="apple-touch-icon" href="{% static brand_logo %}">
  <meta name="apple-mobile-web-app-title" content="{{ brand_name }}" />
  <meta name="application-name" content="{{ brand_name }}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="{% static 'assets/css/style.css' %}" rel="stylesheet" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    :root {
      --app-bg-start: #f4f9fd;
      --app-bg-end: #e6f1fa;
    }

    body {
      background: linear-gradient(180deg, var(--app-bg-start) 0%, var(--app-bg-end) 100%);
      min-height: 100vh;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      color: #1f2d3d;
      margin: 0;
    }

    .app-header {
      background: #fff;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .app-logo {
      width: 44px;
      height: 44px;
    }

    .page-shell {
      min-height: calc(100vh - 120px);
      padding: 16px 0 104px;
    }

    .card-soft {
      border: 1px solid #e6eef5;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.07);
      background: #fff;
    }

    .mobile-bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: #fff;
      border-top: 1px solid #e6eef5;
      padding: 10px 6px 12px;
      z-index: 900;
    }

    .mobile-bottom-nav .bottom-item {
      text-decoration: none;
      color: #7b8a9c;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      flex: 1;
    }

    .mobile-bottom-nav .bottom-item .bottom-icon {
      font-size: 18px;
    }

    .mobile-bottom-nav .bottom-item.active {
      color: #0d6efd;
      font-weight: 600;
    }

    @media (min-width: 992px) {
      .mobile-bottom-nav {
        display: none;
      }
    }

    .toast-container {
      z-index: 1100;
    }

    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: 0.2s ease;
      z-index: 1050;
      display: none;
    }
    .menu-overlay.show {
      opacity: 1;
      visibility: visible;
      display: block;
      pointer-events: auto;
    }
    .mobile-menu {
      position: fixed;
      top: 0;
      left: auto;
      right: -280px;
      width: 260px;
      height: 100vh;
      background: #fff;
      box-shadow: -6px 0 24px rgba(15, 23, 42, 0.08);
      padding: 16px;
      transition: 0.25s ease;
      z-index: 1060;
      pointer-events: none;
    }
    .mobile-menu.open {
      left: auto;
      right: 0;
      pointer-events: auto;
    }

    .hover-shadow {
      transition: box-shadow 0.2s ease, transform 0.2s ease, background 0.2s;
    }
    .hover-shadow:hover {
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
      background: #f8fbff;
      transform: translateY(-1px);
    }

    .dosing-head,
    .dosing-cell {
      background: #eef5ff !important;
    }
    .dosing-group {
      background: #eef5ff !important;
    }

    .offline-toast {
      position: fixed;
      bottom: 90px;
      right: 16px;
      z-index: 1200;
      background: #0d6efd;
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(13, 110, 253, 0.25);
      display: none;
    }
    .plan-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .plan-badge--personal_free {
      background: #e6f8ef;
      color: #1f8f4a;
    }
    .plan-badge--company_trial {
      background: #e6f1fa;
      color: #0d6efd;
    }
    .plan-badge--company_paid {
      background: #f2f1ff;
      color: #4b4fe0;
    }
    .plan-badge--company_expired {
      background: #fdecec;
      color: #b42318;
    }
    [data-requires-access] {
      cursor: not-allowed;
    }
  </style>
  {% block extra_head %}{% endblock %}
</head>

<body>
  {% if user.is_authenticated %}
  <header class="app-header py-3" {% if hide_header %}style="display:none"{% endif %}>
    <div class="container">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div class="d-flex align-items-center gap-3">
          <img src="{% static brand_logo %}" class="app-logo" alt="{{ brand_name }}">
          <div>
            <div class="fw-bold text-dark">{{ brand_name }}</div>
            <div class="text-muted small">&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1072; &#1086;&#1073;&#1089;&#1083;&#1091;&#1078;&#1080;&#1074;&#1072;&#1085;&#1080;&#1103; &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;&#1086;&#1074;</div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-light d-lg-none border-0 shadow-sm" style="width:44px;height:44px;" onclick="openMenu()" aria-label="&#1054;&#1090;&#1082;&#1088;&#1099;&#1090;&#1100; &#1084;&#1077;&#1085;&#1102;">
            <i class="bi bi-list fs-4"></i>
          </button>
          <nav class="d-none d-lg-flex align-items-center gap-3">
          {% if not is_personal_user %}
          <a class="text-decoration-none {% if active_tab == 'readings' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="/readings/all">&#1055;&#1086;&#1082;&#1072;&#1079;&#1072;&#1085;&#1080;&#1103;</a>
          {% endif %}
          <a class="text-decoration-none {% if active_tab == 'pools' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="/pools">
            {% if is_personal_user %}
              &#1052;&#1086;&#1081; &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;
            {% else %}
              &#1052;&#1086;&#1080; &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;&#1099;
            {% endif %}
          </a>
          {% if user.is_authenticated %}
            {% with org_admins=user.organizationaccess_set.all %}
              {% if user.is_superuser or org_admins|length %}
                <a class="text-decoration-none {% if active_tab == 'users' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="{% url 'users' %}">&#1055;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1080;</a>
              {% endif %}
            {% endwith %}
          {% endif %}
          {% if is_org_admin %}
            <a class="text-decoration-none {% if active_tab == 'clients' %}fw-semibold text-primary{% else %}text-muted{% endif %}" href="{% url 'clients_list' %}">&#1050;&#1083;&#1080;&#1077;&#1085;&#1090;&#1099;</a>
          {% endif %}
          <a class="text-decoration-none d-inline-flex align-items-center justify-content-center {% if active_tab == 'profile' %}text-primary{% else %}text-muted{% endif %}" href="{% url 'profile' %}" aria-label="&#1051;&#1080;&#1095;&#1085;&#1099;&#1081; &#1082;&#1072;&#1073;&#1080;&#1085;&#1077;&#1090;" title="&#1051;&#1080;&#1095;&#1085;&#1099;&#1081; &#1082;&#1072;&#1073;&#1080;&#1085;&#1077;&#1090;">
            <i class="bi bi-person-circle fs-5"></i>
          </a>
          </nav>

          {% if plan_badge %}
            <div class="d-none d-lg-flex align-items-center">
              {% if plan_badge.type == 'company_expired' %}
                <a href="{{ payment_url|default:'/billing/' }}" class="plan-badge plan-badge--company_expired text-decoration-none">
                  Trial: 0 &#1076;&#1085;&#1077;&#1081;
                </a>
              {% else %}
                <span class="plan-badge plan-badge--{{ plan_badge.type }}">
                  {% if plan_badge.type == 'personal_free' %}
                    Free (1 &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;)
                  {% elif plan_badge.type == 'company_trial' %}
                    Trial: {{ plan_badge.days_left }} &#1076;&#1085;&#1077;&#1081;
                  {% elif plan_badge.type == 'company_paid' %}
                    Paid &#1076;&#1086; {{ plan_badge.paid_until|date:"d.m.Y" }}
                  {% endif %}
                </span>
              {% endif %}
            </div>
          {% endif %}

          {% if show_add_button and add_url %}
            {% if access_blocked %}
              <a href="{{ add_url }}" class="btn btn-primary btn-lg rounded-3 shadow-sm d-flex align-items-center justify-content-center opacity-50" data-requires-access="true" style="width: 46px; height: 46px;">
                <i class="bi bi-plus-lg"></i>
              </a>
            {% else %}
              <a href="{{ add_url }}" class="btn btn-primary btn-lg rounded-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 46px; height: 46px;">
                <i class="bi bi-plus-lg"></i>
              </a>
            {% endif %}
          {% endif %}

          {% if not user.is_authenticated %}
            <a class="btn btn-primary rounded-3 px-4" href="{% url 'login' %}">&#1042;&#1086;&#1081;&#1090;&#1080;</a>
          {% endif %}
        </div>
      </div>
    </div>
  </header>
  {% endif %}

  <main class="page-shell">
    <div class="container">
      {% if page_title %}
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
          <div>
            <h1 class="fw-bold h3 mb-1">{{ page_title }}</h1>
            {% if page_subtitle %}
              <div class="text-muted">{{ page_subtitle }}</div>
            {% endif %}
          </div>
          {% if page_action_label and page_action_url %}
            {% if access_blocked %}
              <a href="{{ page_action_url }}" class="btn btn-primary rounded-3 d-flex align-items-center gap-2 opacity-50" data-requires-access="true" aria-label="{{ page_action_label }}" title="{{ page_action_label }}">
                <i class="bi bi-plus-lg"></i><span class="d-none d-sm-inline">{{ page_action_label }}</span>
              </a>
            {% else %}
              <a href="{{ page_action_url }}" class="btn btn-primary rounded-3 d-flex align-items-center gap-2" aria-label="{{ page_action_label }}" title="{{ page_action_label }}">
                <i class="bi bi-plus-lg"></i><span class="d-none d-sm-inline">{{ page_action_label }}</span>
              </a>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- Mobile drawer -->
  {% if user.is_authenticated %}
  <div id="menu-overlay" class="menu-overlay" onclick="closeMenu()"></div>
  <div id="mobile-menu" class="mobile-menu">
      <div class="menu-header d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center gap-2">
              <img src="{% static brand_logo %}" class="app-logo" alt="{{ brand_name }}" style="width:38px;height:38px;">
              <div>
                  <div class="fw-bold text-dark">{{ brand_name }}</div>
                  <div class="text-muted small">&#1052;&#1077;&#1085;&#1102;</div>
              </div>
          </div>
          <button class="btn btn-light border-0" onclick="closeMenu()" aria-label="&#1047;&#1072;&#1082;&#1088;&#1099;&#1090;&#1100; &#1084;&#1077;&#1085;&#1102;">
              <i class="bi bi-x-lg"></i>
          </button>
      </div>
      {% if plan_badge %}
      <div class="mb-3">
          {% if plan_badge.type == 'company_expired' %}
          <a href="{{ payment_url|default:'/billing/' }}" class="plan-badge plan-badge--company_expired text-decoration-none">
              Trial: 0 &#1076;&#1085;&#1077;&#1081;
          </a>
          {% else %}
          <span class="plan-badge plan-badge--{{ plan_badge.type }}">
              {% if plan_badge.type == 'personal_free' %}
              Free (1 &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;)
              {% elif plan_badge.type == 'company_trial' %}
              Trial: {{ plan_badge.days_left }} &#1076;&#1085;&#1077;&#1081;
              {% elif plan_badge.type == 'company_paid' %}
              Paid &#1076;&#1086; {{ plan_badge.paid_until|date:"d.m.Y" }}
              {% endif %}
          </span>
          {% endif %}
      </div>
      {% endif %}
      <div class="list-group list-group-flush">
          <a href="{% url 'profile' %}" class="list-group-item list-group-item-action">&#1055;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;</a>
          <a href="/pools" class="list-group-item list-group-item-action">
            {% if is_personal_user %}
              &#1052;&#1086;&#1081; &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;
            {% else %}
              &#1052;&#1086;&#1080; &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;&#1099;
            {% endif %}
          </a>
          {% if is_org_admin %}
          <a href="{% url 'clients_list' %}" class="list-group-item list-group-item-action">&#1050;&#1083;&#1080;&#1077;&#1085;&#1090;&#1099;</a>
          {% endif %}
          {% if not is_personal_user %}
          <a href="/readings/all" class="list-group-item list-group-item-action">&#1055;&#1086;&#1082;&#1072;&#1079;&#1072;&#1085;&#1080;&#1103;</a>
          {% endif %}
          {% if user.is_authenticated %}
            {% with org_admins=user.organizationaccess_set.all %}
              {% if user.is_superuser or org_admins|length %}
                <a href="{% url 'users' %}" class="list-group-item list-group-item-action">&#1055;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1080;</a>
              {% endif %}
            {% endwith %}
          {% endif %}
          {% if user.is_authenticated %}
          <form method="post" action="{% url 'logout' %}" class="list-group-item list-group-item-action p-0 border-0">
              {% csrf_token %}
              <button class="btn w-100 text-start">&#1042;&#1099;&#1081;&#1090;&#1080;</button>
          </form>
          {% endif %}
      </div>
  </div>
  {% endif %}

    <div id="install-banner" class="position-fixed bottom-0 start-0 end-0 p-3" style="z-index:1080; display:none;">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
          <div>
            <div class="fw-semibold">&#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1077; {{ brand_name }}</div>
            <div class="text-muted small">&#1044;&#1086;&#1073;&#1072;&#1074;&#1100;&#1090;&#1077; &#1087;&#1088;&#1080;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1075;&#1083;&#1072;&#1074;&#1085;&#1099;&#1081; &#1101;&#1082;&#1088;&#1072;&#1085; &#1076;&#1083;&#1103; &#1073;&#1099;&#1089;&#1090;&#1088;&#1086;&#1075;&#1086; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087;&#1072;.</div>
          </div>
          <div class="d-flex gap-2">
            <button id="install-dismiss" type="button" class="btn btn-outline-secondary btn-sm">&#1055;&#1086;&#1079;&#1078;&#1077;</button>
            <button id="install-btn" type="button" class="btn btn-primary btn-sm">&#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100;</button>
          </div>
        </div>
      </div>
    </div>
    <div id="ios-install-banner" class="position-fixed bottom-0 start-0 end-0 p-3" style="z-index:1080; display:none;">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex flex-column gap-2">
          <div class="fw-semibold">&#1044;&#1086;&#1073;&#1072;&#1074;&#1100;&#1090;&#1077; {{ brand_name }} &#1085;&#1072; &#1101;&#1082;&#1088;&#1072;&#1085; &#171;&#1044;&#1086;&#1084;&#1086;&#1081;&#187;</div>
          <div class="text-muted small">&#1053;&#1072;&#1078;&#1084;&#1080;&#1090;&#1077; &#171;&#1055;&#1086;&#1076;&#1077;&#1083;&#1080;&#1090;&#1100;&#1089;&#1103;&#187; &#1080; &#1074;&#1099;&#1073;&#1077;&#1088;&#1080;&#1090;&#1077; &#171;&#1053;&#1072; &#1101;&#1082;&#1088;&#1072;&#1085; &#1044;&#1086;&#1084;&#1086;&#1081;&#187;.</div>
          <div class="d-flex gap-2">
            <button id="ios-install-dismiss" type="button" class="btn btn-outline-secondary btn-sm">&#1055;&#1086;&#1085;&#1103;&#1090;&#1085;&#1086;</button>
          </div>
        </div>
      </div>
    </div>

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
  {% if messages %}
    {% for message in messages %}
      <div class="toast align-items-center text-bg-light border-0 shadow-sm mb-2 show" role="alert">
        <div class="d-flex">
            <div class="toast-body">
              {% if message.tags %}
                <span class="badge bg-light text-dark border me-2 text-uppercase">{{ message.tags }}</span>
              {% endif %}
              {{ message }}
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <div id="offline-toast" class="offline-toast"></div>
  <div class="modal fade" id="accessBlockedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">&#1044;&#1086;&#1089;&#1090;&#1091;&#1087; &#1079;&#1072;&#1073;&#1083;&#1086;&#1082;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          &#1055;&#1088;&#1086;&#1073;&#1085;&#1099;&#1081; &#1087;&#1077;&#1088;&#1080;&#1086;&#1076; &#1080;&#1083;&#1080; &#1086;&#1087;&#1083;&#1072;&#1095;&#1077;&#1085;&#1085;&#1099;&#1081; &#1087;&#1077;&#1088;&#1080;&#1086;&#1076; &#1079;&#1072;&#1082;&#1086;&#1085;&#1095;&#1080;&#1083;&#1089;&#1103;. &#1044;&#1083;&#1103; &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103; &#1088;&#1072;&#1073;&#1086;&#1090;&#1099; &#1086;&#1087;&#1083;&#1072;&#1090;&#1080;&#1090;&#1077; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087;.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">&#1054;&#1090;&#1084;&#1077;&#1085;&#1072;</button>
          <a href="{{ payment_url|default:'/billing/' }}" class="btn btn-primary">&#1055;&#1077;&#1088;&#1077;&#1081;&#1090;&#1080; &#1082; &#1086;&#1087;&#1083;&#1072;&#1090;&#1077;</a>
        </div>
      </div>
    </div>
  </div>

  {% if not hide_bottom_nav %}
  {% if user.is_authenticated %}
      <div class="mobile-bottom-nav">
      <a href="/pools" class="bottom-item {% if active_tab == 'pools' %}active{% endif %}">
        <i class="bi bi-stack bottom-icon"></i>
        <span>
          {% if is_personal_user %}
            &#1052;&#1086;&#1081; &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;
          {% else %}
            &#1052;&#1086;&#1080; &#1073;&#1072;&#1089;&#1089;&#1077;&#1081;&#1085;&#1099;
          {% endif %}
        </span>
      </a>
      {% if not is_personal_user %}
      <a href="/readings/all" class="bottom-item {% if active_tab == 'readings' %}active{% endif %}">
        <i class="bi bi-journal-text bottom-icon"></i>
        <span>&#1055;&#1086;&#1082;&#1072;&#1079;&#1072;&#1085;&#1080;&#1103;</span>
      </a>
      {% endif %}
      <a href="{% url 'profile' %}" class="bottom-item {% if active_tab == 'profile' %}active{% endif %}">
        <i class="bi bi-person-circle bottom-icon"></i>
        <span>&#1055;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;</span>
      </a>
  </div>
  {% endif %}
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".toast").forEach(function (el) {
        const toast = new bootstrap.Toast(el, { delay: 4000 });
        toast.show();
      });

      // сбрасываем состояние мобильного меню при загрузке
      closeMenu();
    });

    function openMenu() {
      document.getElementById("mobile-menu").classList.add("open");
      document.getElementById("menu-overlay").classList.add("show");
    }
    function closeMenu() {
      document.getElementById("mobile-menu").classList.remove("open");
      document.getElementById("menu-overlay").classList.remove("show");
    }

    // simple offline form queue
    const offlineToast = document.getElementById("offline-toast");
    function showOfflineToast(text) {
      if (!offlineToast) return;
      offlineToast.textContent = text;
      offlineToast.style.display = "block";
      setTimeout(() => (offlineToast.style.display = "none"), 4000);
    }

    function loadQueue() {
      try {
        return JSON.parse(localStorage.getItem("offlineQueue") || "[]");
      } catch (e) {
        return [];
      }
    }
    function saveQueue(queue) {
      localStorage.setItem("offlineQueue", JSON.stringify(queue));
    }

    function updateOfflineStatus() {
      const statusEl = document.getElementById("offline-status");
      if (!statusEl) return;
      const queued = loadQueue().length;
      if (!navigator.onLine) {
        statusEl.textContent = "\u041e\u0444\u043b\u0430\u0439\u043d: \u0434\u0430\u043d\u043d\u044b\u0435 \u0431\u0443\u0434\u0443\u0442 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u044b \u0438 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043f\u0440\u0438 \u043f\u043e\u044f\u0432\u043b\u0435\u043d\u0438\u0438 \u0441\u0435\u0442\u0438.";
        statusEl.classList.remove("d-none");
        return;
      }
      if (queued) {
        statusEl.textContent = "\u0415\u0441\u0442\u044c \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435. \u041e\u043d\u0438 \u043e\u0442\u043f\u0440\u0430\u0432\u044f\u0442\u0441\u044f \u043f\u0440\u0438 \u043f\u043e\u044f\u0432\u043b\u0435\u043d\u0438\u0438 \u0441\u0435\u0442\u0438.";
        statusEl.classList.remove("d-none");
        return;
      }
      statusEl.classList.add("d-none");
    }

    async function processQueue() {
      const queue = loadQueue();
      if (!queue.length || !navigator.onLine) {
        updateOfflineStatus();
        return;
      }
      let sentCount = 0;
      while (queue.length) {
        const item = queue[0];
        try {
          const resp = await fetch(item.action, {
            method: item.method,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
              "X-CSRFToken": item.csrf || "",
            },
            body: item.body,
            credentials: "include",
          });
          if (!resp.ok) throw new Error("Network error");
          queue.shift();
          saveQueue(queue);
          sentCount += 1;
        } catch (e) {
          break;
        }
      }
      if (sentCount > 0 && queue.length === 0) {
        showOfflineToast("\u0421\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b.");
      }
      updateOfflineStatus();
    }

    window.addEventListener("online", processQueue);
    window.addEventListener("offline", updateOfflineStatus);

    document.addEventListener("submit", function (e) {
      const form = e.target;
      if (!form.classList.contains("offline-queue-form")) return;
      if (navigator.onLine) return;

      e.preventDefault();
      const fd = new FormData(form);
      const params = new URLSearchParams(fd);
      const csrf = fd.get("csrfmiddlewaretoken") || "";
      const queue = loadQueue();
      queue.push({
        action: form.action,
        method: form.method || "POST",
        body: params.toString(),
        csrf,
      });
      saveQueue(queue);
      showOfflineToast("\u041d\u0435\u0442 \u0441\u0435\u0442\u0438. \u0414\u0430\u043d\u043d\u044b\u0435 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u044b \u0438 \u0431\u0443\u0434\u0443\u0442 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043f\u0440\u0438 \u0432\u043e\u0441\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0438 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f.");
      updateOfflineStatus();
    });

    if (navigator.onLine) {
      processQueue();
    }
    updateOfflineStatus();

    // PWA: регистрация service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").catch((err) => console.error("SW registration failed", err));
      });
    }

    // PWA: собственный промпт установки
    let deferredPrompt = null;
    const installBanner = document.getElementById("install-banner");
    const installBtn = document.getElementById("install-btn");
    const installDismiss = document.getElementById("install-dismiss");

    function showInstallBanner() {
      if (!installBanner) return;
      installBanner.style.display = "block";
    }
    function hideInstallBanner() {
      if (!installBanner) return;
      installBanner.style.display = "none";
    }

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      if (window.matchMedia("(display-mode: standalone)").matches) return;
      deferredPrompt = e;
      showInstallBanner();
    });

    installBtn?.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      hideInstallBanner();
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    });

    installDismiss?.addEventListener("click", () => {
      hideInstallBanner();
      deferredPrompt = null;
    });

    window.addEventListener("appinstalled", () => {
      hideInstallBanner();
      deferredPrompt = null;
    });

    // iOS install hint (custom banner)
    const iosBanner = document.getElementById("ios-install-banner");
    const iosDismiss = document.getElementById("ios-install-dismiss");
    function isIosDevice() {
      const ua = navigator.userAgent || "";
      const iOS = /iphone|ipad|ipod/i.test(ua);
      const iPadOS = navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1;
      return iOS || iPadOS;
    }
    function isStandalone() {
      return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
    }
    function showIosBanner() {
      if (!iosBanner) return;
      iosBanner.style.display = "block";
    }
    function hideIosBanner() {
      if (!iosBanner) return;
      iosBanner.style.display = "none";
    }
    function iosDismissed() {
      try {
        return localStorage.getItem("iosInstallDismissed") === "1";
      } catch (e) {
        return false;
      }
    }
    function setIosDismissed() {
      try {
        localStorage.setItem("iosInstallDismissed", "1");
      } catch (e) {}
    }
    if (isIosDevice() && !isStandalone() && !iosDismissed()) {
      showIosBanner();
    }
    iosDismiss?.addEventListener("click", () => {
      hideIosBanner();
      setIosDismissed();
    });
  </script>
  <script>
    function formatPhoneMask(value) {
      let digits = value.replace(/\D/g, "");
      if (digits.startsWith("8")) digits = digits.slice(1);
      if (digits.startsWith("7")) digits = digits.slice(1);
      digits = digits.slice(0, 10);
      let res = "+7";
      if (digits.length > 0) res += " " + digits.substring(0, Math.min(3, digits.length));
      if (digits.length > 3) res += " " + digits.substring(3, Math.min(6, digits.length));
      if (digits.length > 6) res += " " + digits.substring(6, Math.min(10, digits.length));
      return res.trimEnd();
    }

    function applyPhoneMasks(root) {
      const scope = root || document;
      const selector = ".phone-mask, input[type='tel'], input[name*='phone'], input[name*='Phone']";
      scope.querySelectorAll(selector).forEach((inp) => {
        if (inp.dataset.phoneMask === "1") return;
        inp.dataset.phoneMask = "1";
        inp.classList.add("phone-mask");
        inp.value = formatPhoneMask(inp.value || "+7");
        inp.addEventListener("input", () => {
          inp.value = formatPhoneMask(inp.value);
          inp.setSelectionRange(inp.value.length, inp.value.length);
        });
        inp.addEventListener("focus", () => {
          if (!inp.value.trim()) inp.value = "+7 ";
        });
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      applyPhoneMasks();
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const accessBlocked = {{ access_blocked|default:False|yesno:"true,false" }};
      if (!accessBlocked) return;
      const modalEl = document.getElementById("accessBlockedModal");
      if (!modalEl) return;
      const modal = new bootstrap.Modal(modalEl);
      document.querySelectorAll("[data-requires-access]").forEach((el) => {
        el.addEventListener("click", (event) => {
          event.preventDefault();
          modal.show();
        });
      });
    });
  </script>
</body>
</html>
