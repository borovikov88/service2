{% extends 'pool_service/base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="card card-soft p-4">
    <h3 class="fw-bold h5 mb-3">{{ page_title }}</h3>
    <form method="post" class="offline-queue-form">
        {% csrf_token %}
        {% if next_url %}<input type="hidden" name="next" value="{{ next_url }}">{% endif %}
        <div class="row g-3">
            <div class="col-12">
                <label class="form-label d-block mb-1">Тип клиента</label>
                <div class="d-flex flex-column gap-2">
                    {% for choice in form.client_type %}
                        <label class="border rounded-3 p-2">
                            {{ choice.tag }} <span class="ms-2">{{ choice.choice_label }}</span>
                        </label>
                    {% endfor %}
                </div>
                {% if form.client_type.errors %}<div class="text-danger small">{{ form.client_type.errors.0 }}</div>{% endif %}
            </div>

            <div id="legal-fields" class="row g-3">
                <div class="col-12">
                    <label class="form-label">Название организации <span class="text-danger">*</span></label>
                    {{ form.company_name }}
                    {% if form.company_name.errors %}<div class="text-danger small">{{ form.company_name.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-6">
                    <label class="form-label">ИНН</label>
                    {{ form.inn }}
                    {% if form.inn.errors %}<div class="text-danger small">{{ form.inn.errors.0 }}</div>{% endif %}
                </div>
            </div>

            <div class="col-12 mt-2" id="contact-heading">
                <div class="fw-semibold">Контактное лицо</div>
            </div>
            <div class="row g-3" id="contact-fields">
                <div class="col-md-6">
                    <label class="form-label">Имя <span class="text-danger">*</span></label>
                    {{ form.first_name }}
                    {% if form.first_name.errors %}<div class="text-danger small">{{ form.first_name.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-6">
                    <label class="form-label">Фамилия <span class="text-danger">*</span></label>
                    {{ form.last_name }}
                    {% if form.last_name.errors %}<div class="text-danger small">{{ form.last_name.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-6" id="contact-position-field">
                    <label class="form-label">Должность <span class="text-danger">*</span></label>
                    {{ form.contact_position }}
                    {% if form.contact_position.errors %}<div class="text-danger small">{{ form.contact_position.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-6">
                    <label class="form-label">Телефон <span class="text-danger">*</span></label>
                    {{ form.phone }}
                    {% if form.phone.errors %}<div class="text-danger small">{{ form.phone.errors.0 }}</div>{% endif %}
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    {{ form.email }}
                    {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>
        <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary {% if access_blocked %}opacity-50{% endif %}" {% if access_blocked %}data-requires-access="true"{% endif %}>{% if is_edit %}Сохранить{% else %}Создать{% endif %}</button>
            <a href="{% if is_edit %}{% url 'clients_list' %}{% else %}{% url 'pool_list' %}{% endif %}" class="btn btn-outline-secondary">Отмена</a>
        </div>
    </form>
</div>
<script>
    function toggleClientFields() {
        const type = document.querySelector('input[name="client_type"]:checked')?.value;
        const legalBlock = document.getElementById("legal-fields");
        const contactHeading = document.getElementById("contact-heading");
        const contactPosition = document.getElementById("contact-position-field");
        if (type === "legal") {
            legalBlock.style.display = "";
            if (contactHeading) contactHeading.style.display = "";
            if (contactPosition) contactPosition.style.display = "";
        } else {
            legalBlock.style.display = "none";
            if (contactHeading) contactHeading.style.display = "none";
            if (contactPosition) contactPosition.style.display = "none";
        }
    }
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('input[name="client_type"]').forEach(el => {
            el.addEventListener("change", toggleClientFields);
        });
        toggleClientFields();

        function formatPhone(value) {
            let digits = value.replace(/\D/g, "");
            if (digits.startsWith("8")) digits = digits.slice(1);
            if (digits.startsWith("7")) digits = digits.slice(1);
            digits = digits.slice(0, 10);
            let res = "+7";
            if (digits.length > 0) res += " " + digits.substring(0, Math.min(3, digits.length));
            if (digits.length > 3) res += " " + digits.substring(3, Math.min(6, digits.length));
            if (digits.length > 6) res += " " + digits.substring(6, Math.min(10, digits.length));
            return res.trimEnd();
        }
        document.querySelectorAll(".phone-mask").forEach(inp => {
            inp.value = formatPhone(inp.value || "+7");
            inp.addEventListener("input", () => {
                inp.value = formatPhone(inp.value);
                inp.setSelectionRange(inp.value.length, inp.value.length);
            });
            inp.addEventListener("focus", () => {
                if (!inp.value.trim()) inp.value = "+7 ";
            });
        });

        const form = document.querySelector("form");
        if (form) {
            let dirty = false;
            const markDirty = () => {
                dirty = true;
            };
            form.addEventListener("input", markDirty);
            form.addEventListener("change", markDirty);
            form.addEventListener("submit", () => {
                dirty = false;
            });
            window.addEventListener("beforeunload", (event) => {
                if (!dirty) return;
                event.preventDefault();
                event.returnValue = "";
            });
        }
    });
</script>
{% endblock %}
