{% extends 'pool_service/base.html' %}
{% load static %}
{% block title %}
  {% if is_edit %}
    {% if pool.object_type == 'water' %}Редактирование записи{% else %}Редактирование показания{% endif %}
  {% else %}
    {% if pool.object_type == 'water' %}Новая запись{% else %}Новое показание{% endif %}
  {% endif %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{% url 'pool_detail' pool.uuid %}" class="text-decoration-none d-flex align-items-center gap-2 text-dark">
        <i class="bi bi-arrow-left"></i>
        <span class="fw-semibold">Назад к объекту</span>
    </a>
</div>

<div class="card card-soft p-4 mb-4">
    <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
        <div>
            <h2 class="fw-bold h4 mb-1">{{ pool.client.name }}</h2>
            <div class="text-muted"><i class="bi bi-geo-alt me-1"></i>{{ pool.address }}</div>
        </div>
    </div>

    <div class="card card-soft p-4">
        <h3 class="fw-bold h5 mb-1">
            {% if is_edit %}
                {% if pool.object_type == 'water' %}Редактирование записи{% else %}Редактирование показания{% endif %}
            {% else %}
                {% if pool.object_type == 'water' %}Новая запись{% else %}Новое показание{% endif %}
            {% endif %}
        </h3>
        <p class="text-muted mb-3">
            {% if is_edit %}
                {% if pool.object_type == 'water' %}
                    Обновите данные визита для {{ pool.client.name }}
                {% else %}
                    Обновите данные замеров для {{ pool.client.name }}
                {% endif %}
            {% else %}
                {% if pool.object_type == 'water' %}
                    Заполните данные визита для {{ pool.client.name }}
                {% else %}
                    Заполните данные замеров для {{ pool.client.name }}
                {% endif %}
            {% endif %}
        </p>

        <div id="offline-status" class="alert alert-warning d-none mb-3"></div>
        <form method="post" class="offline-queue-form" novalidate>
            {% csrf_token %}
            {{ form.date }}

            {% if pool.object_type != 'water' %}
            <div class="row g-3 mb-2">
                <div class="col-md-6">
                    <label class="form-label fw-semibold"><i class="bi bi-thermometer me-2"></i>&#1058;&#1077;&#1084;&#1087;&#1077;&#1088;&#1072;&#1090;&#1091;&#1088;&#1072; (&#176;C)</label>
                    {{ form.temperature }}
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold"><i class="bi bi-flask me-2"></i>pH</label>
                    {{ form.ph }}
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold"><i class="bi bi-droplet me-2"></i>&#1057;&#1074;&#1086;&#1073;&#1086;&#1076;&#1085;&#1099;&#1081; &#1093;&#1083;&#1086;&#1088; (&#1084;&#1075;/&#1083;)</label>
                    {{ form.cl_free }}
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold"><i class="bi bi-droplet-half me-2"></i>&#1054;&#1073;&#1097;&#1080;&#1081; &#1093;&#1083;&#1086;&#1088; (&#1084;&#1075;/&#1083;)</label>
                    {{ form.cl_total }}
                </div>
            </div>

            <div class="card card-soft p-3 mb-3">
                <div class="d-flex align-items-center justify-content-between gap-2">
                    <div class="fw-semibold d-flex align-items-center gap-2">
                        <i class="bi bi-sliders"></i>
                        &#1057;&#1090;&#1072;&#1085;&#1094;&#1080;&#1103; &#1076;&#1086;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="toggle-dosing"></button>
                </div>
                <div id="dosing-fields" class="d-none mt-3">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold"><i class="bi bi-flask me-2"></i>pH, &#1089;&#1090;&#1072;&#1085;&#1094;&#1080;&#1103; &#1076;&#1086;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;</label>
                            {{ form.ph_dosing_station }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold"><i class="bi bi-droplet me-2"></i>&#1057;&#1074;&#1086;&#1073;&#1086;&#1076;&#1085;&#1099;&#1081; &#1093;&#1083;&#1086;&#1088;, &#1089;&#1090;&#1072;&#1085;&#1094;&#1080;&#1103; &#1076;&#1086;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;</label>
                            {{ form.cl_free_dosing_station }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold"><i class="bi bi-activity me-2"></i>Redox, &#1089;&#1090;&#1072;&#1085;&#1094;&#1080;&#1103; &#1076;&#1086;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;</label>
                            {{ form.redox_dosing_station }}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="mb-3">
                <label class="form-label fw-semibold"><i class="bi bi-chat-left-text me-2"></i>&#1050;&#1086;&#1084;&#1084;&#1077;&#1085;&#1090;&#1072;&#1088;&#1080;&#1081;</label>
                {{ form.comment }}
            </div>

            {% if pool.object_type != 'water' %}
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold"><i class="bi bi-box-seam me-2"></i>&#1053;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1099;&#1077; &#1084;&#1072;&#1090;&#1077;&#1088;&#1080;&#1072;&#1083;&#1099;</label>
                    {{ form.required_materials }}
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold"><i class="bi bi-tools me-2"></i>&#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1085;&#1099;&#1077; &#1088;&#1072;&#1073;&#1086;&#1090;&#1099;</label>
                    {{ form.performed_works }}
                </div>
            </div>
            {% endif %}
            <div class="mb-3">
                <label class="form-label fw-semibold"><i class="bi bi-arrow-repeat me-2"></i>Замены расходников</label>
                {{ form.consumables_replaced }}
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg {% if access_blocked %}opacity-50{% endif %}" {% if access_blocked %}data-requires-access="true"{% endif %}>&#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1090;&#1100;</button>
                <a href="{% url 'pool_detail' pool.uuid %}" class="btn btn-outline-secondary btn-lg">Отмена</a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const toggleBtn = document.getElementById("toggle-dosing");
        const dosing = document.getElementById("dosing-fields");
        const updateToggleText = () => {
            if (!toggleBtn || !dosing) return;
            toggleBtn.textContent = dosing.classList.contains("d-none")
                ? "\u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b"
                : "\u0421\u043a\u0440\u044b\u0442\u044c \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b";
        };

        if (toggleBtn && dosing) {
            const inputs = dosing.querySelectorAll("input");
            const hasValue = Array.from(inputs).some((input) => String(input.value || "").trim().length);
            if (hasValue) {
                dosing.classList.remove("d-none");
            }
            updateToggleText();
            toggleBtn.addEventListener("click", function() {
                dosing.classList.toggle("d-none");
                updateToggleText();
            });
        }

        {% if not is_edit %}
        const dateField = document.querySelector('input[name="date"]');
        if (dateField) {
            const tzoffset = (new Date()).getTimezoneOffset() * 60000;
            dateField.value = new Date(Date.now() - tzoffset).toISOString().slice(0, -1);
        }
        {% endif %}

        const form = document.querySelector("form");
        if (form) {
            let dirty = false;
            const markDirty = () => {
                dirty = true;
            };
            form.addEventListener("input", markDirty);
            form.addEventListener("change", markDirty);
            form.addEventListener("submit", () => {
                dirty = false;
            });
            window.addEventListener("beforeunload", (event) => {
                if (!dirty) return;
                event.preventDefault();
                event.returnValue = "";
            });
        }
    });
</script>
{% endblock %}
