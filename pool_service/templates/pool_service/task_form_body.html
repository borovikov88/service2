<form method="post" action="{{ form_action|default:'' }}" class="d-flex flex-column gap-3 task-form" data-task-form>
  {% csrf_token %}
  {% if next_url %}
    <input type="hidden" name="next" value="{{ next_url }}">
  {% endif %}
  {% if is_modal %}
    <input type="hidden" name="modal" value="1">
  {% endif %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger mb-0">{{ form.non_field_errors }}</div>
  {% endif %}

  <div>
    {{ form.title }}
    {% if form.title.errors %}
      <div class="text-danger small mt-1">{{ form.title.errors }}</div>
    {% endif %}
  </div>

  <div>
    {{ form.description }}
    {% if form.description.errors %}
      <div class="text-danger small mt-1">{{ form.description.errors }}</div>
    {% endif %}
  </div>

  <div class="task-form__row d-flex flex-wrap align-items-center gap-2">
    <div class="task-form__field task-form__field--date">
      {{ form.start_date }}
    </div>
    <span class="task-form__separator">—</span>
    <div class="task-form__field task-form__field--date">
      {{ form.end_date }}
    </div>
  </div>
  {% if form.start_date.errors or form.end_date.errors %}
    <div class="text-danger small">
      {{ form.start_date.errors }} {{ form.end_date.errors }}
    </div>
  {% endif %}

  <div class="form-check">
    <input type="checkbox" class="form-check-input" id="task-time-toggle" data-task-time-toggle {% if has_time %}checked{% endif %}>
    <label class="form-check-label" for="task-time-toggle">Добавить время</label>
  </div>
  <div class="task-form__row d-flex flex-wrap align-items-center gap-2 {% if not has_time %}d-none{% endif %}" data-task-time-fields>
    <div class="task-form__field task-form__field--time">
      {{ form.start_time }}
    </div>
    <span class="task-form__separator">—</span>
    <div class="task-form__field task-form__field--time">
      {{ form.end_time }}
    </div>
  </div>
  {% if form.start_time.errors or form.end_time.errors %}
    <div class="text-danger small">
      {{ form.start_time.errors }} {{ form.end_time.errors }}
    </div>
  {% endif %}

  <div>
    <label class="form-label">Участники</label>
    {% if required_responsible_id %}
      <input type="hidden" name="responsibles" value="{{ required_responsible_id }}">
    {% endif %}
    <div data-responsibles-block>
      <div class="multi-select" data-multi-select data-placeholder="Выберите участников">
        <button type="button" class="multi-select__trigger" data-multi-select-trigger>
          <span class="multi-select__value"></span>
          <span class="multi-select__caret" aria-hidden="true">
            <i class="bi bi-chevron-down"></i>
          </span>
        </button>
        <div class="multi-select__dropdown" data-multi-select-list>
          {% for option in responsible_options %}
            <label class="multi-select__option{% if option.id == required_responsible_id %} multi-select__option--locked{% endif %}">
              <input
                type="checkbox"
                name="responsibles"
                value="{{ option.id }}"
                {% if option.id|stringformat:"s" in selected_responsibles or option.id == required_responsible_id %}checked{% endif %}
                {% if option.id == required_responsible_id %}data-locked="1" disabled{% endif %}
              >
              <span>{{ option.name }}</span>
            </label>
          {% empty %}
            <div class="multi-select__empty">Нет доступных сотрудников.</div>
          {% endfor %}
        </div>
      </div>
      {% if form.responsibles.errors %}
        <div class="text-danger small mt-1">{{ form.responsibles.errors }}</div>
      {% endif %}
    </div>
  </div>

  <div class="d-flex flex-wrap align-items-center gap-4">
    <div class="form-check">
      {{ form.is_important }}
      <label class="form-check-label d-flex align-items-center gap-2" for="{{ form.is_important.id_for_label }}">
        <i class="bi bi-fire text-danger"></i>
        Важная задача
      </label>
    </div>
    {% if task %}
      <div class="form-check">
        {{ form.is_completed }}
        <label class="form-check-label" for="{{ form.is_completed.id_for_label }}">{{ form.is_completed.label }}</label>
      </div>
    {% endif %}
  </div>

  <div class="d-flex flex-wrap gap-2">
    <button type="submit" class="btn btn-primary rounded-3">Сохранить</button>
    {% if is_modal %}
      <button type="button" class="btn btn-outline-secondary rounded-3" data-bs-dismiss="modal">Закрыть</button>
    {% elif next_url %}
      <a class="btn btn-outline-secondary rounded-3" href="{{ next_url }}">Назад к календарю</a>
    {% else %}
      <a class="btn btn-outline-secondary rounded-3" href="{% url 'readings_all' %}">Назад к календарю</a>
    {% endif %}
  </div>
</form>

{% if task %}
  <div class="d-flex flex-wrap gap-2 mt-2">
    <form method="post" action="{% url 'task_delete' task.id %}" class="d-inline">
      {% csrf_token %}
      {% if next_url %}
        <input type="hidden" name="next" value="{{ next_url }}">
      {% endif %}
      {% if is_modal %}
        <input type="hidden" name="modal" value="1">
      {% endif %}
      <button
        type="submit"
        class="btn btn-outline-danger rounded-3 js-confirm-action"
        data-confirm-title="РЈРґР°Р»РёС‚СЊ Р·Р°РґР°С‡Сѓ?"
        data-confirm-body="Р—Р°РґР°С‡Р° Р±СѓРґРµС‚ СѓРґР°Р»РµРЅР° Р±РµР· РІРѕР·РјРѕР¶РЅРѕСЃС‚Рё РІРѕСЃСЃС‚Р°РЅРѕРІР»РµРЅРёСЏ."
        data-confirm-confirm="РЈРґР°Р»РёС‚СЊ"
        data-confirm-variant="danger"
      >
        РЈРґР°Р»РёС‚СЊ
      </button>
    </form>
  </div>
{% endif %}

{% if show_history and history %}
  <details class="task-history mt-3">
    <summary class="task-history__summary">История изменений</summary>
    <div class="table-responsive mt-3">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Дата</th>
            <th>Кто</th>
            <th>Действие</th>
            <th>Поле</th>
            <th>Было</th>
            <th>Стало</th>
          </tr>
        </thead>
        <tbody>
          {% for row in history %}
            <tr>
              <td>{{ row.created_at|date:"d.m.Y H:i" }}</td>
              <td>{{ row.user|default:"-" }}</td>
              <td>{{ row.action }}</td>
              <td>{{ row.field|default:"-" }}</td>
              <td class="text-muted">{{ row.old_value|default:"-" }}</td>
              <td>{{ row.new_value|default:"-" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </details>
{% endif %}
